{% extends 'base.html' %} {% block title %}Cat√°logo | Todas as M√∫sicas Spotify{%
endblock %} {% block content %} {{ dados_para_js|json_script:"spotify-data" }}

<h1 style="color: #00b409">
  ¬†üìö Cat√°logo de M√∫sicas (Dataset Spotify)
  <hr style="border-color: #282828" />
</h1>
<p>
  ¬†Visualize, ordene e utilize os <strong>IDs</strong> das m√∫sicas para as
  simula√ß√µes de busca. Total de registros:
  <strong id="totalRegistros">Carregando...</strong>
</p>

<style>
  /* Estilos base (Mantenha o estilo escuro do Spotify) */
  body {
    background-color: #121212;
    color: #ffffff;
  }

  a {
    color: #00b409;
    text-decoration: none;
  }

  a:hover {
    color: #1ed760;
  }

  .container-main {
    display: flex;
    gap: 40px;
    margin-top: 30px;
  }

  strong {
    color: #00b409;
    /* Seu verde de destaque */
  }

  .column-left {
    flex: 0 0 350px;
    /* Coluna de Controles */
  }

  .column-right {
    flex: 1;
    /* Coluna de Listagem (Janela) */
  }

  /* Estilo da Caixa de Comandos (Coluna Esquerda) */
  .command-box {
    border: 1px solid #222222;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background-color: #1a1a1a;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  }

  /* Estilo da "Janela" de Listagem */
  .list-window {
    height: 600px;
    /* Altura fixa para a janela de rolagem */
    overflow-y: auto;
    /* Adiciona barra de rolagem vertical */
    border: 1px solid #222222;
    border-radius: 8px;
    background-color: #1e1e1e;
    /* Fundo levemente mais claro que o body */
    padding: 0;
    /* Remove padding interno para a tabela */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  }

  .list-window::-webkit-scrollbar {
    width: 8px;
    background-color: transparent;
    /* Remove o fundo (a parte branca que voc√™ n√£o gosta) */
  }

  .list-window::-webkit-scrollbar-thumb {
    background-color: #555;
    /* Cor cinza escuro para o scroll */
    border-radius: 10px;
    /* A borda abaixo √© CR√çTICA para que o scroll n√£o ocupe toda a largura do trilho transparente */
    border: 2px solid #1e1e1e;
  }

  .list-window::-webkit-scrollbar-thumb:hover {
    background-color: #777;
  }

  /* Suporte Firefox (Opcional, mas recomendado) */
  .list-window {
    scrollbar-width: thin;
    scrollbar-color: #555 #1e1e1e;
  }

  /* Estilo da Tabela */
  .song-table {
    width: 100%;
    border-collapse: collapse;
  }

  .song-table th {
    background-color: #282828;
    color: #b3b3b3;
    padding: 10px;
    text-align: left;
    position: sticky;
    /* Fixa o cabe√ßalho ao rolar */
    top: 0;
    z-index: 10;
    cursor: pointer;
  }

  .song-table td {
    padding: 10px;
    border-bottom: 1px solid #333333;
    vertical-align: middle;
    font-size: 0.9em;
  }

  .song-table tr:hover {
    background-color: #2a2a2a;
  }

  /* Estilo para o ID da M√∫sica */
  .track-id-cell {
    font-family: monospace;
    color: #00b409;
    /* ID em verde para destaque */
    font-size: 0.8em;
    cursor: copy;
    /* √çcone de c√≥pia */
    transition: color 0.2s;
  }

  .track-id-cell:hover {
    color: #1ed760;
  }

  /* MUDAN√áA: Estilo dos bot√µes de filtro */
  .filter-buttons {
    /* Define o container como flex e for√ßa o empilhamento vertical */
    display: flex;
    flex-direction: column;
    gap: 10px;
    /* Espa√ßo entre os bot√µes */
  }

  .filter-buttons button {
    background-color: #00b409;
    color: black;
    /* Texto preto para alto contraste */
    border: none;
    padding: 10px 15px;
    margin: 0;
    /* Remove margens que podem afetar o layout de coluna */
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
    width: 100%;
    /* Garante que todos ocupem a largura m√°xima da coluna */
    text-align: left;
    /* Alinha o texto √† esquerda para um visual mais limpo */
  }

  .filter-buttons button:hover {
    background-color: #1ed760;
  }

  /* Estilo para o bot√£o ativo/selecionado */
  .filter-buttons button.active {
    background-color: #1ed760;
    border: 2px solid #00b409;
    box-shadow: 0 0 8px rgba(0, 180, 9, 0.7);
  }

  /* ----------------------------------------------- */
  /* --- MEDIA QUERIES PARA RESPONSIVIDADE --- */
  /* ----------------------------------------------- */

  @media (max-width: 768px) {
    /* 1. Layout Principal (Colunas -> Linha √önica) */
    .container-main {
      flex-direction: column; /* Empilha a coluna de comandos e a lista */
      gap: 20px;
      margin-top: 15px;
    }

    /* 2. Colunas */
    .column-left,
    .column-right {
      flex: 1 1 auto; /* Ocupam a largura total */
      min-width: 100%;
    }

    /* Remove a altura fixa da janela em mobile (ou reduz bastante) */
    .list-window {
      height: auto; /* A altura se ajusta ao conte√∫do */
      max-height: 500px; /* Define uma altura m√°xima razo√°vel para rolagem */
      overflow-y: auto;
    }

    /* 3. Tabela (Ajustes para Mobile) */
    .song-table,
    .song-table tbody,
    .song-table tr,
    .song-table td {
      display: block; /* Transforma a tabela em um elemento de bloco */
    }

    .song-table th {
      /* Cabe√ßalhos s√£o importantes, mas manteremos o display 'table-cell' no desktop */
      position: static;
      display: table-cell; /* Garante que o cabe√ßalho se mantenha na horizontal */
    }

    /* Rola apenas o conte√∫do da tabela para evitar scroll horizontal da p√°gina inteira */
    .column-right .list-window {
      overflow-x: auto;
    }

    /* Garante que a tabela n√£o transborde */
    .song-table {
      min-width: 600px; /* Garante que a tabela mantenha uma largura m√≠nima leg√≠vel */
    }

    /* 4. Estilo de C√©lula (Alternativa a display: block) */
    /* Para uma tabela grande, a melhor solu√ß√£o √© for√ßar a rolagem horizontal interna,
       como feito acima no .column-right .list-window */

    .song-table th,
    .song-table td {
      padding: 8px 5px; /* Reduz o padding para ganhar espa√ßo */
      font-size: 0.85em; /* Reduz a fonte */
    }

    /* Reduz a largura da coluna de ID (a mais longa) */
    .song-table th:last-child,
    .song-table td:last-child {
      width: 120px; /* Largura m√≠nima para o ID */
    }

    .track-id-cell {
      word-break: break-all; /* Quebra palavras longas (IDs) se necess√°rio */
    }
  }
</style>

<div class="container-main">
  <div class="column-left">
    <div class="command-box">
      <h2>Op√ß√µes de Listagem:</h2>
      <div class="filter-buttons">
        <button id="original-btn" onclick="sortList('original_order', this)">
          Ordem Padr√£o (BD)
        </button>

        <button id="pop-desc-btn" onclick="sortList('popularidade_desc', this)">
          üî• Mais Populares
        </button>
        <button id="pop-asc-btn" onclick="sortList('popularidade_asc', this)">
          üßä Menos Populares
        </button>
        <button id="nome-asc-btn" onclick="sortList('nome_asc', this)">
          T√≠tulo (A-Z)
        </button>
      </div>
      <p style="margin-top: 20px; font-size: 0.9em; color: #b3b3b3">
        ¬†Clique no cabe√ßalho da coluna "Popularidade" para inverter rapidamente
        a ordena√ß√£o.
      </p>
    </div>
  </div>

  <div class="column-right">
    <h2>Lista de M√∫sicas:</h2>

    <div class="list-window">
      <table class="song-table">
        <thead>
          <tr>
            <th>Nome da M√∫sica</th>
            <th>Artista</th>
            <th id="popularidade-header">Popularidade</th>
            <th>ID da M√∫sica</th>
          </tr>
        </thead>
        <tbody id="music-list-body">
          <tr>
            <td colspan="4" style="text-align: center">Carregando dados...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // Vari√°veis Globais e Leitura de Dados
  let rawData = [];
  // Define a ordem inicial como a 'original_order'
  let currentSortOrder = "original_order";

  const scriptElement = document.getElementById("spotify-data");
  if (scriptElement && scriptElement.textContent.trim().length > 0) {
    try {
      rawData = JSON.parse(scriptElement.textContent);
    } catch (e) {
      console.error(
        "Erro fatal: N√£o foi poss√≠vel processar os dados do servidor.",
        e
      );
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // 1. Atualiza o contador de registros
    document.getElementById("totalRegistros").textContent = rawData.length;

    // 2. Renderiza a lista inicial com a Ordem Padr√£o do BD
    renderList(rawData, currentSortOrder);

    // 3. Define o bot√£o 'Ordem Padr√£o (BD)' como ativo
    document.getElementById("original-btn").classList.add("active"); // Bot√£o inicial

    // 4. Adiciona evento de clique ao cabe√ßalho da popularidade
    document
      .getElementById("popularidade-header")
      .addEventListener("click", togglePopularitySort);
  });

  /**
   * Renderiza a tabela com o array de m√∫sicas fornecido.
   */
  function renderList(musicArray, sortOrder) {
    const tbody = document.getElementById("music-list-body");
    let htmlContent = "";

    // 1. Ordena o Array - CLONA para n√£o modificar o array original
    const sortedArray = [...musicArray];

    // Se for 'original_order', n√£o reordena.
    if (sortOrder !== "original_order") {
      sortedArray.sort((a, b) => {
        const popA = parseInt(a.track_popularity);
        const popB = parseInt(b.track_popularity);

        if (sortOrder === "popularidade_desc") {
          return popB - popA;
        } else if (sortOrder === "popularidade_asc") {
          return popA - popB;
        } else if (sortOrder === "nome_asc") {
          return a.track_name.localeCompare(b.track_name);
        }
        return 0;
      });
    }

    // 2. Gera o HTML das linhas
    sortedArray.forEach((musica) => {
      htmlContent += `
  <tr>
   <td>${musica.track_name}</td>
   <td>${musica.track_artist}</td>
   <td>${musica.track_popularity}</td>
   <td class="track-id-cell" title="Clique para copiar o ID: ${musica.track_id}" onclick="copyToClipboard('${musica.track_id}')">${musica.track_id}</td>
  </tr>
  `;
    });

    tbody.innerHTML = htmlContent;

    // 3. Atualiza o √≠cone de ordena√ß√£o no cabe√ßalho
    const header = document.getElementById("popularidade-header");

    if (sortOrder.startsWith("popularidade")) {
      header.innerHTML = `Popularidade (${
        sortOrder === "popularidade_desc" ? "‚Üì" : "‚Üë"
      })`;
    } else {
      header.innerHTML = `Popularidade`;
    }
  }

  /**
   * Alterna a ordena√ß√£o de popularidade entre ascendente e descendente (usado pelo TH).
   */
  function togglePopularitySort() {
    let targetButton;

    if (currentSortOrder === "popularidade_desc") {
      currentSortOrder = "popularidade_asc";
      targetButton = document.getElementById("pop-asc-btn");
    } else {
      currentSortOrder = "popularidade_desc";
      targetButton = document.getElementById("pop-desc-btn");
    }
    renderList(rawData, currentSortOrder);
    setActiveButton(targetButton);
  }

  /**
   * Fun√ß√£o de ordena√ß√£o gen√©rica (usada pelos bot√µes)
   */
  function sortList(criteria, buttonElement) {
    currentSortOrder = criteria;
    renderList(rawData, currentSortOrder);
    setActiveButton(buttonElement);
  }

  /**
   * Gerencia o estado "ativo" dos bot√µes.
   */
  function setActiveButton(activeButton) {
    const buttons = document.querySelectorAll(".filter-buttons button");
    buttons.forEach((btn) => btn.classList.remove("active"));
    if (activeButton) {
      activeButton.classList.add("active");
    }
  }

  /**
   * Fun√ß√£o utilit√°ria para copiar o ID.
   */
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(
      () => {
        alert("ID copiado para a √°rea de transfer√™ncia: " + text);
      },
      (err) => {
        console.error("Erro ao copiar: ", err);
        // Fallback para navegadores mais antigos
        prompt("Copie manualmente o ID:", text);
      }
    );
  }
</script>

{% endblock content %}
