{% extends 'base.html' %} 

{% block title %}Cat√°logo | Todas as M√∫sicas Spotify{% endblock %}

{% block content %}

    
    {{ dados_para_js|json_script:"spotify-data" }}

  <h1 style="color: #1DB954">
    üìö Cat√°logo de M√∫sicas (Dataset Spotify)
    <hr>
  </h1>
  <p>
    Visualize, ordene e utilize os <strong>IDs</strong> das m√∫sicas para as simula√ß√µes de busca. Total de registros: <strong id="totalRegistros">Carregando...</strong>
  </p>

  <style>
        /* Estilos base (Mantenha o estilo escuro do Spotify) */
        body { background-color: #121212; color: #ffffff; }
        a { color: #1DB954; }
        
        .container-main {
            display: flex;
            gap: 40px; 
            margin-top: 30px;
        }

        strong{
        color: #00b409;
        }

        .column-left {
            flex: 0 0 350px; /* Coluna de Controles */
        }

        .column-right {
            flex: 1; /* Coluna de Listagem (Janela) */
        }

        /* Estilo da "Janela" de Listagem */
        .list-window {
            height: 600px; /* Altura fixa para a janela de rolagem */
            overflow-y: auto; /* Adiciona barra de rolagem vertical */
            border: 1px solid #222222;
            border-radius: 8px;
            background-color: #1E1E1E; /* Fundo levemente mais claro que o body */
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        /* Estilo da Tabela */
        .song-table {
            width: 100%;
            border-collapse: collapse;
        }
        .song-table th {
            background-color: #282828; 
            color: #b3b3b3;
            padding: 10px;
            text-align: left;
            position: sticky; /* Fixa o cabe√ßalho ao rolar */
            top: 0;
            z-index: 10;
            cursor: pointer; /* Indica que √© clic√°vel para ordenar */
        }
        .song-table td {
            padding: 10px;
            border-bottom: 1px solid #333333;
            vertical-align: middle;
            font-size: 0.9em;
        }
        .song-table tr:hover {
            background-color: #2a2a2a;
        }
        
        /* Estilo para o ID da M√∫sica */
        .track-id-cell {
            font-family: monospace;
            color: #b3b3b3;
            font-size: 0.8em;
        }
        
        /* Estilo dos bot√µes de filtro */
        .filter-buttons button {
            background-color: #1DB954;
            color: white;
            border: none;
            padding: 10px 15px;
            margin-right: 10px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .filter-buttons button:hover {
            background-color: #1ed760;
        }
  </style>

    <div class="container-main">

        <div class="column-left">
             <h2>Op√ß√µes de Listagem:</h2>
             <div class="filter-buttons">
                           <button onclick="sortList('popularidade_desc')">üî• Mais Populares</button>
          <button onclick="sortList('popularidade_asc')">üßä Menos Populares</button>
                <button onclick="sortList('nome_asc')">T√≠tulo (A-Z)</button>
             </div>
             <p style="margin-top: 20px; font-size: 0.9em; color: #b3b3b3;">
                 Clique no cabe√ßalho da coluna "Popularidade" para inverter a ordena√ß√£o.
             </p>
        </div>


        <div class="column-right">
             <h2>Lista de M√∫sicas:</h2>
             
             <div class="list-window">
                 <table class="song-table">
                     <thead>
                         <tr>
                             <th>Nome da M√∫sica</th>
                             <th>Artista</th>
                             <th id="popularidade-header">Popularidade (‚Üì)</th>
                             <th>ID da M√∫sica</th>
                         </tr>
                     </thead>
                     <tbody id="music-list-body">
                         <tr><td colspan="4" style="text-align: center;">Carregando dados...</td></tr>
                     </tbody>
                 </table>
             </div>
        </div>

    </div>

  <script>
        // LEITURA DE DADOS SEGURA
        let rawData = [];
        let currentSortOrder = 'popularidade_desc'; // Estado inicial de ordena√ß√£o

        const scriptElement = document.getElementById('spotify-data');
        if (scriptElement && scriptElement.textContent.trim().length > 0) {
            try {
                rawData = JSON.parse(scriptElement.textContent);
            } catch (e) {
                console.error("Erro fatal: N√£o foi poss√≠vel processar os dados do servidor.", e);
            }
        }
    
        document.addEventListener('DOMContentLoaded', () => {
             // 1. Atualiza o contador de registros
      document.getElementById('totalRegistros').textContent = rawData.length;
            
            // 2. Renderiza a lista inicial (ordenada por popularidade descendente)
            renderList(rawData, currentSortOrder);
            
            // 3. Adiciona evento de clique ao cabe√ßalho da popularidade
            document.getElementById('popularidade-header').addEventListener('click', togglePopularitySort);
        });

        /**
         * Renderiza a tabela com o array de m√∫sicas fornecido.
         */
        function renderList(musicArray, sortOrder) {
            const tbody = document.getElementById('music-list-body');
            let htmlContent = '';
            
            // 1. Ordena o Array
            const sortedArray = [...musicArray]; // Clona para n√£o modificar o original
            
            sortedArray.sort((a, b) => {
                // Converte Popularidade para n√∫mero para garantir ordena√ß√£o correta
                const popA = parseInt(a.track_popularity);
                const popB = parseInt(b.track_popularity);

                if (sortOrder === 'popularidade_desc') {
                    return popB - popA; // Maior para o menor
                } else if (sortOrder === 'popularidade_asc') {
                    return popA - popB; // Menor para o maior
                } else if (sortOrder === 'nome_asc') {
                    // Ordena√ß√£o por nome (string)
                    return a.track_name.localeCompare(b.track_name);
                }
                return 0; // Se for o mesmo
            });

            // 2. Gera o HTML das linhas
            sortedArray.forEach(musica => {
                htmlContent += `
                    <tr>
                        <td>${musica.track_name}</td>
                        <td>${musica.track_artist}</td>
                        <td>${musica.track_popularity}</td>
                        <td class="track-id-cell" title="Clique para copiar o ID: ${musica.track_id}" onclick="copyToClipboard('${musica.track_id}')">${musica.track_id}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = htmlContent;
            
            // 3. Atualiza o √≠cone de ordena√ß√£o no cabe√ßalho
            const header = document.getElementById('popularidade-header');
            header.innerHTML = `Popularidade (${sortOrder === 'popularidade_desc' ? '‚Üì' : '‚Üë'})`;
        }
        
        /**
         * Alterna a ordena√ß√£o de popularidade entre ascendente e descendente.
         */
        function togglePopularitySort() {
            if (currentSortOrder === 'popularidade_desc') {
                currentSortOrder = 'popularidade_asc';
            } else {
                currentSortOrder = 'popularidade_desc';
            }
            renderList(rawData, currentSortOrder);
        }

        /**
         * Fun√ß√£o de ordena√ß√£o gen√©rica (usada pelos bot√µes)
         */
        function sortList(criteria) {
            currentSortOrder = criteria;
            renderList(rawData, currentSortOrder);
        }
        
        /**
         * Fun√ß√£o utilit√°ria para copiar o ID.
         */
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert("ID copiado: " + text);
            }, (err) => {
                console.error('Erro ao copiar: ', err);
            });
        }
    </script>

{% endblock content %}