{% extends 'base.html' %} 

{% block title %}Filtragem por ClassificaÃ§Ã£o | CatÃ¡logo Premium{%endblock %} 

{% block content %}
{{ dados_para_js|json_script:"spotify-data" }}

<h1 style="color: #00b409">
 ðŸ“Š Filtragem por ClassificaÃ§Ã£o: GÃªnero e Artista
 <hr style="border-color: #333333" />
</h1>
<p>
 Explore nosso catÃ¡logo filtrando por categorias. Selecione um <strong>GÃªnero</strong>, refine pelo <strong>Artista</strong> e encontre a faixa desejada.
</p>

<style>
 /* Estilos do Template - Foco em Preto e seu Verde #00b409 */

 /* Layout de Duas Colunas */
 .container-main {
  display: flex;
  gap: 40px;
  margin-top: 30px;
 }

 .column-left {
  flex: 0 0 350px;
 }

 .column-right {
  flex: 1;
 }

 /* Caixa de Comandos (Filtros) */
 .command-box {
  border: 1px solid #222222;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  background-color: #1a1a1a;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
 }

 strong {
  color: #00b409;
 }

 .controls {
  display: flex;
  flex-direction: column;
  gap: 15px;
 }

 .controls label {
  color: #e0e0e0;
  margin-bottom: 0;
  font-weight: bold;
  display: block;
  font-size: 0.9em;
 }

 /* Estilo para os Dropdowns */
 .controls select {
  width: 100%;
  padding: 10px;
  border-radius: 5px;
  border: 1px solid #333;
  background-color: #242424;
  color: #ffffff;
  appearance: none;
  background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300b409%22%20d%3D%22M287%2C79.4L146.2%2C220.2L5.4%2C79.4c-8.9-8.9-23.2-8.9-32.1%2C0c-8.9%2C8.9-8.9%2C23.2%2C0%2C32.1l156%2C156c4.5%2C4.5%2C10.4%2C6.7%2C16.1%2C6.7c5.7%2C0%2C11.5-2.2%2C16.1-6.7l156-156c8.9-8.9%2C8.9-23.2%2C0-32.1C310.2%2C70.5%2C295.9%2C70.5%2C287%2C79.4z%22%2F%3E%3C%2Fsvg%3E');
  background-repeat: no-repeat;
  background-position: right 10px top 50%;
  background-size: 0.6em auto;
 }

 .controls select:focus,
 .controls input:focus {
  border-color: #00b409;
  outline: none;
 }
 
  /* Estilo para o campo INPUT de Artista (Datalist) */
  .controls input {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #333;
      background-color: #242424;
      color: #ffffff;
  }

 /* Resultado (Coluna Direita) - Lista de MÃºsicas/Artistas */
 .result-box {
  border: 1px solid #222222;
  border-radius: 8px;
  padding: 20px;
  background-color: #1a1a1a;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  margin-top: 15px;
  min-height: 200px;
  max-height: 500px; /* Limita a altura para rolagem */
  overflow-y: auto;
 }

 .music-list-item {
  border-bottom: 1px solid #282828;
  padding: 10px 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background-color 0.2s;
 }

 .music-list-item:hover {
  background-color: #1c1c1c;
 }

 .music-list-item:last-child {
  border-bottom: none;
 }

 .track-name {
  color: #ffffff;
  font-weight: 600;
  font-size: 1.1em;
 }

 .track-artist {
  color: #b3b3b3;
  font-size: 0.9em;
 }

 .track-meta {
  font-size: 0.8em;
  color: #999;
 }

 .status-message {
  color: #b3b3b3;
  font-style: italic;
 }

 /* --- MEDIA QUERIES PARA RESPONSIVIDADE --- */

 @media (max-width: 768px) {
  .container-main {
   flex-direction: column;
   gap: 20px;
   margin-top: 15px;
  }

  .column-left,
  .column-right {
   flex: 1 1 auto;
   min-width: 100%;
  }

  .command-box {
   padding: 15px;
  }

  .controls {
   gap: 10px;
  }
 }
</style>


<div class="container-main">
 <div class="column-left">
  <div class="command-box">
   <p style="margin-top: 0; font-weight: bold">
    1. Escolha a Categoria
   </p>
   <div class="controls">
    <div>
     <label for="genre-select">GÃªnero Principal:</label>
     <select id="genre-select">
      <option value="">Selecione um GÃªnero...</option>
     </select>
    </div>

            <div>
     <label for="artist-input">Artista (Refinar - Digite ou Selecione):</label>
            <input 
                type="text" 
                id="artist-input" 
                placeholder="(Opcional) Digite o nome do Artista..." 
                disabled
                list="artist-options" 
            />
            <datalist id="artist-options">
                </datalist>
    </div>
           </div>
  </div>
 </div>

 <div class="column-right">
  <h2>Resultados da ClassificaÃ§Ã£o:</h2>
  <div id="resultBox" class="result-box">
   <p class="status-message">
    Carregando...
   </p>
  </div>
 </div>
</div>

<script>
    // VARIÃVEIS DE ESCOPO GLOBAL
    let rawData = [];
    const indexedData = {}; 

    // ReferÃªncias dos elementos DOM
    const genreSelect = document.getElementById("genre-select");
    // NOVAS REFERÃŠNCIAS para INPUT e DATALIST
    const artistInput = document.getElementById("artist-input"); 
    const artistDatalist = document.getElementById("artist-options"); 
    const resultBox = document.getElementById("resultBox");

    // 1. LEITURA DE DADOS
    try {
        const scriptElement = document.getElementById("spotify-data");
        if (scriptElement && scriptElement.textContent.trim().length > 0) {
            rawData = JSON.parse(scriptElement.textContent);
        }
    } catch (e) {
        console.error("Erro ao processar dados JSON:", e);
    }
    
    /**
     * FUNÃ‡ÃƒO PRINCIPAL: ConstrÃ³i a estrutura hierÃ¡rquica (Ãndices).
     * RESILIENTE: Trata campos vazios/nulos.
     */
    function buildIndexes() {
        if (rawData.length === 0) {
            console.warn("âš ï¸ IndexaÃ§Ã£o nÃ£o iniciada: rawData estÃ¡ vazio.");
            return;
        }
        
        rawData.forEach((music) => {
            // FIX: Trata valores nulos/vazios
            const genre = music.playlist_genre ? music.playlist_genre.trim() : "GÃªnero Desconhecido"; 
            const artist = music.track_artist ? music.track_artist.trim() : "Artista Desconhecido";

            // Ignora registros totalmente incompletos
            if (genre === "GÃªnero Desconhecido" && artist === "Artista Desconhecido") {
                 return;
            }

            if (!indexedData[genre]) {
                indexedData[genre] = {};
            }

            if (!indexedData[genre][artist]) {
                indexedData[genre][artist] = [];
            }

            indexedData[genre][artist].push(music);
        });
    }

    /**
     * Popula o dropdown de GÃªneros.
     */
    function populateGenres() {
        genreSelect.innerHTML = '<option value="">Selecione um GÃªnero...</option>';
        if (Object.keys(indexedData).length === 0) return;

        const sortedGenres = Object.keys(indexedData).sort();
        
        sortedGenres.forEach((genre) => {
            const artistCount = Object.keys(indexedData[genre]).length;
            const option = new Option(`${genre} (${artistCount} Artistas)`, genre);
            genreSelect.add(option);
        });
        genreSelect.disabled = false;
    }

    /**
     * Exibe a lista de Artistas do GÃªnero selecionado na caixa de resultados.
     */
    function displayArtists(genre) {
        if (!genre || !indexedData[genre]) {
            resultBox.innerHTML = '<p class="status-message">Selecione um GÃªnero para listar artistas.</p>';
            return;
        }

        const artistsData = indexedData[genre];
        const artists = Object.keys(artistsData).sort((a, b) => a.localeCompare(b));
        
        let htmlContent = `
            <p style="color: #00b409; font-weight: bold;">
                Artistas em ${genre}: ${artists.length}
            </p>
            <div style="height: 350px; overflow-y: auto; padding: 5px;">
        `;

        artists.forEach((artist) => {
            const musicCount = artistsData[artist].length;
            htmlContent += `
                <div class="music-list-item" style="cursor: pointer;" 
                     onclick="selectArtistFromList('${artist.replace(/'/g, "\\'")}')">
                    <div>
                        <div class="track-name">${artist}</div>
                        <div class="track-artist">${musicCount} Faixas</div>
                    </div>
                    <div class="track-meta">
                        Clique para Filtrar
                    </div>
                </div>
            `;
        });
        
        htmlContent += '</div>';
        resultBox.innerHTML = htmlContent;
    }
    
    /**
     * Seleciona o artista no input ao clicar na lista de resultados e dispara o filtro.
     */
    window.selectArtistFromList = function(artistName) {
        artistInput.value = artistName;
        // Chama o filtro para exibir as mÃºsicas
        handleArtistChange(); 
    }


    /**
   * LÃ“GICA DE FILTRO: Popula o DATALIST e exibe a lista de Artistas.
   */
  function handleGenreChange() {
    const selectedGenre = genreSelect.value;

    // Limpa e prepara o INPUT/DATALIST
    artistInput.value = ''; 
    artistDatalist.innerHTML = ''; 
        artistInput.disabled = true;

    if (selectedGenre) {
      const artists = Object.keys(indexedData[selectedGenre]).sort();
      
            // 1. Popula o DATALIST (SugestÃµes de digitaÃ§Ã£o)
      artists.forEach((artist) => {
        const option = document.createElement('option');
                option.value = artist;
                artistDatalist.appendChild(option);
      });

      artistInput.disabled = false;
            
            // 2. EXIBE A LISTA DE ARTISTAS NO RESULTADO
            displayArtists(selectedGenre);
            
    } else {
      // Sem gÃªnero selecionado, volta ao padrÃ£o
      displaySongs(rawData);
    }
  }

  /**
   * LÃ“GICA DE FILTRO: ResponsÃ¡vel por filtrar mÃºsicas quando o INPUT muda (digitaÃ§Ã£o ou seleÃ§Ã£o).
   */
  function handleArtistChange() {
    const selectedGenre = genreSelect.value;
    const selectedArtist = artistInput.value.trim(); // Lendo o valor do INPUT
    
    resultBox.innerHTML =
      '<p class="status-message">Carregando...</p>';

    if (selectedGenre && selectedArtist) {
      // CenÃ¡rio A: GÃªnero E Artista digitado -> Busca Faixas
      const songs = indexedData[selectedGenre][selectedArtist];
      
      if (songs) {
        displaySongs(songs);
      } else {
        // O valor digitado nÃ£o corresponde a um artista vÃ¡lido no Ã­ndice
        resultBox.innerHTML = 
          `<p class="status-message">Artista "${selectedArtist}" nÃ£o encontrado no gÃªnero ${selectedGenre}.</p>`;
      }

    } else if (selectedGenre && !selectedArtist) {
            // CenÃ¡rio B: Apenas GÃªnero selecionado (o input foi limpo) -> Volta a exibir a lista de Artistas
            displayArtists(selectedGenre);
        } else {
      // CenÃ¡rio C: Nenhum filtro ativo
      displaySongs(rawData);
    }
  }

  /**
   * Renderiza a lista de mÃºsicas no resultBox.
   */
  function displaySongs(songs) {
    if (!songs || songs.length === 0) {
      resultBox.innerHTML =
        '<p class="status-message">Nenhuma faixa encontrada para essa seleÃ§Ã£o.</p>';
      return;
    }

    let htmlContent = `
      <p style="color: #b3b3b3; font-weight: bold;">
        Faixas encontradas: ${songs.length}
      </p>`;
    
    songs.forEach((song) => {
      const popularity = song.track_popularity || 'N/A';

      htmlContent += `
        <div class="music-list-item">
          <div>
            <div class="track-name">${song.track_name || 'Nome Desconhecido'}</div>
            <div class="track-artist">${song.track_artist || 'Artista Desconhecido'}</div>
          </div>
          <div class="track-meta">
            Pop: ${popularity}%
          </div>
        </div>
      `;
    });

    resultBox.innerHTML = htmlContent;
  }

  // 2. EVENTO DE CARREGAMENTO DA PÃGINA
  document.addEventListener("DOMContentLoaded", () => {
    buildIndexes(); 
    populateGenres(); 
    
        // Inicia mostrando a lista completa
    displaySongs(rawData);
    
    genreSelect.addEventListener("change", handleGenreChange);
        // NOVO: Usando o evento 'input' no campo de texto para reagir Ã  digitaÃ§Ã£o
    artistInput.addEventListener("input", handleArtistChange); 
  });
</script>

{% endblock content %}