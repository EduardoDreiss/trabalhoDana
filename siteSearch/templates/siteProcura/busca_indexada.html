{% extends 'base.html' %}

{% block title %}Busca Indexada | M√∫sicas Spotify{% endblock %}

{% block content %}

{{ dados_para_js|json_script:"spotify-data" }}

<h1 style="color: #00b409">
    üìä Busca Indexada (O(log N)) - Dataset Spotify
    <hr style="border-color: #282828;">
</h1>
<p>
    Objetivo: Demonstra√ß√£o da otimiza√ß√£o <strong>O(log N)</strong>, utilizando o algoritmo de <strong>Busca
        Bin√°ria</strong>. A efici√™ncia depende do array de IDs de m√∫sica estar <strong>ordenado</strong> (Estrutura
    Indexada).
</p>

<style>
    /* Estilos do Template - Foco em Preto e seu Verde #00b409 */

    /* Layout de Duas Colunas */
    .container-main {
        display: flex;
        gap: 40px;
        margin-top: 30px;
    }

    .column-left {
        flex: 0 0 350px;
        /* Coluna de largura fixa para os controles */
    }

    .column-right {
        flex: 1;
        /* Coluna de resultados */
    }

    /* Caixa de Comandos (Coluna Esquerda) */
    .command-box {
        border: 1px solid #222222;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background-color: #1a1a1a;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    /* Controles (Input e Bot√£o) */
    .controls {
        margin-bottom: 20px;
    }

    strong {
        color: #00b409;
    }

    button {
        background-color: #00b409;
        color: black;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
    }

    button:hover {
        background-color: #1ed760;
    }

    /* Resultado (Coluna Direita) */
    .result-box {
        border: 1px solid #222222;
        border-radius: 8px;
        padding: 20px;
        background-color: #121212;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        margin-top: 15px;
    }

    /* Cores de Status */
    .found {
        border-color: #00b409;
    }

    .not-found {
        border-color: #f44336;
    }

    /* Estilos de Informa√ß√£o da M√∫sica */
    .result-title {
        color: #00b409;
        font-size: 1.3em;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .track-details p {
        margin: 5px 0;
        line-height: 1.4;
    }

    .data-warning {
        color: #b3b3b3;
        font-size: 0.9em;
        margin-top: 10px;
    }
</style>

<div class="container-main">

    <div class="column-left">
        <div class="command-box">
            <p style="margin-top: 0; font-weight: bold;">**Configura√ß√£o O(log N)**</p>
            <div class="controls">
                <label for="target">Buscar M√∫sica por ID:</label>
                <input type="text" id="target" value="" style="width: 300px; padding: 5px;"
                    placeholder="Ex: ID da M√∫sica">
                <button id="startButton">Iniciar Busca Bin√°ria</button>
            </div>
        </div>

        <p id="totalRegistros">Carregando dados...</p>
        <p id="data-status" class="data-warning">O array de busca √© carregado <strong>ORDENADO</strong> pelo 'track_id'
            (requisito para a Busca Bin√°ria).</p>
    </div>


    <div class="column-right">
        <h2>Resultado da Busca:</h2>
        <p id="time-elapsed">Tempo de Busca: <strong>0 ms</strong></p>
        <p id="status-steps">Passos de Compara√ß√£o: <strong>0</strong> (Logar√≠tmico)</p>

        <div id="resultBox" class="result-box">
            <p id="status">Aguardando a busca...</p>
        </div>
    </div>

</div>

<script>
    // VARI√ÅVEIS DE ESCOPO GLOBAL
    let rawData = [];
    let isSearching = false;

    // 1. LEITURA DE DADOS (Lendo da tag <script> com o ID "spotify-data")
    const scriptElement = document.getElementById('spotify-data');
    if (scriptElement && scriptElement.textContent.trim().length > 0) {
        try {
            rawData = JSON.parse(scriptElement.textContent);
        } catch (e) {
            console.error("Erro fatal: N√£o foi poss√≠vel processar os dados do servidor.", e);
        }
    }

    /**
    * Atualiza o box de resultado com a informa√ß√£o formatada.
    */
    function displayResult(statusText, steps, success = true, music = null, duration = 0) {
        const resultBox = document.getElementById('resultBox');
        const timeElapsed = document.getElementById('time-elapsed');
        const statusSteps = document.getElementById('status-steps');

        timeElapsed.innerHTML = `Tempo de Busca: <strong>${duration.toFixed(3)} ms</strong>`;
        statusSteps.innerHTML = `Passos de Compara√ß√£o: <strong>${steps}</strong>`;

        let htmlContent = '';

        if (success && music) {
            htmlContent = `
          <p class="result-title">‚úÖ M√∫sica ENCONTRADA!</p>
          <div class="track-details">
            <p><strong>T√≠tulo:</strong> ${music.track_name}</p>
            <p><strong>Artista:</strong> ${music.track_artist}</p>
            <p><strong>Popularidade:</strong> ${music.track_popularity}</p>
                        <p style="font-size: 0.8em; color: #b3b3b3;">ID: ${music.track_id}</p>
          </div>
        `;
        } else {
            htmlContent = `<p class="not-found">‚ùå ${statusText}</p>`;
        }

        resultBox.innerHTML = htmlContent;

        resultBox.classList.remove('found', 'not-found');
        resultBox.classList.add(success ? 'found' : 'not-found');
    }

    function resetSearch() {
        isSearching = false;
        document.getElementById('time-elapsed').innerHTML = `Tempo de Busca: <strong>0 ms</strong>`;
        document.getElementById('status-steps').innerHTML = `Passos de Compara√ß√£o: <strong>0</strong> (Logar√≠tmico)`;
        document.getElementById('resultBox').innerHTML = '<p id="status">Aguardando a busca...</p>';
        document.getElementById('resultBox').classList.remove('found', 'not-found');
    }

    /**
    * Algoritmo de Busca Bin√°ria
    */
    function binarySearch(arr, targetId) {
        let left = 0;
        let right = arr.length - 1;
        let steps = 0;
        let foundMusic = null;

        while (left <= right) {
            steps++;
            let mid = Math.floor((left + right) / 2);
            const currentId = arr[mid].track_id;

            // Compara√ß√£o de strings (IDs)
            if (currentId === targetId) {
                foundMusic = arr[mid];
                break;
            }

            // Usamos localeCompare para garantir que a ordem de strings seja correta
            else if (currentId.localeCompare(targetId) < 0) {
                left = mid + 1;
            }
            else {
                right = mid - 1;
            }
        }

        return {
            music: foundMusic,
            steps: steps
        };
    }

    function startSearch() {
        if (isSearching || rawData.length === 0) return;

        isSearching = true;
        resetSearch();

        const targetId = document.getElementById('target').value.trim();

        document.getElementById('status').textContent = `Iniciando Busca Indexada (Bin√°ria) para ID: ${targetId}...`;

        const startTime = performance.now();
        // Executa a busca
        const { music, steps } = binarySearch(rawData, targetId);
        const endTime = performance.now();
        const duration = endTime - startTime;


        if (music) {
            displayResult(`M√∫sica ENCONTRADA!`, steps, true, music, duration);
        } else {
            displayResult(`M√∫sica com ID "${targetId}" N√ÉO ENCONTRADA.`, steps, false, null, duration);
        }

        isSearching = false;
    }


    // 2. EVENTO DE CARREGAMENTO DA P√ÅGINA
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('totalRegistros').textContent = `Total de M√∫sicas no Banco (Estrutura Ordenada): ${rawData.length}`;

        // Define um ID de exemplo
        if (rawData.length > 0) {
            document.getElementById('target').value = rawData[0].track_id;
        } else {
            document.getElementById('target').value = 'Verifique a View/Popula√ß√£o';
        }

        // Anexa a fun√ß√£o startSearch() ao clique do bot√£o
        const startButton = document.getElementById('startButton');
        if (startButton) {
            startButton.addEventListener('click', startSearch);
        }
    });
</script>

{% endblock content %}