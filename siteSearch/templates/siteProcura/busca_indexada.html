{% extends 'base.html' %}

{% block title %}Busca Indexada | M√∫sicas Spotify{% endblock %}

{% block content %}

{{ dados_para_js|json_script:"spotify-data" }}

<h1 style="color: #00b409">
 üìä Busca Indexada (O(log N)) - Dataset Spotify
 <hr style="border-color: #282828;">
</h1>
<p>
 Objetivo: Demonstra√ß√£o da otimiza√ß√£o <strong>O(log N)</strong>, utilizando o algoritmo de <strong>Busca
  Bin√°ria</strong>. A efici√™ncia depende do array de IDs de m√∫sica estar <strong>ordenado</strong> (Estrutura
 Indexada).
</p>

<style>
 /* Estilos do Template - Foco em Preto e seu Verde #00b409 */

 /* Layout de Duas Colunas */
 .container-main {
  display: flex;
  gap: 40px;
  margin-top: 30px;
 }

 .column-left {
  flex: 0 0 350px;
  /* Coluna de largura fixa para os controles */
 }

 .column-right {
  flex: 1;
  /* Coluna de resultados */
 }

 /* Caixa de Comandos (Coluna Esquerda) */
 .command-box {
  border: 1px solid #222222;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  background-color: #1a1a1a;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
 }

 /* Controles (Input e Bot√£o) */
 .controls {
  margin-bottom: 20px;
 }

 strong {
  color: #00b409;
 }

 button {
  background-color: #00b409;
  color: black;
  border: none;
  padding: 10px 15px;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  transition: background-color 0.3s;
  border: 1px solid #000000;
  margin-top: 10px;
 }

 button:hover {
  background-color: #1ed760;
 }

 /* Resultado (Coluna Direita) */
 .result-box {
  border: 1px solid #222222;
  border-radius: 8px;
  padding: 20px;
  background-color: #121212;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  margin-top: 15px;
 }

 /* Cores de Status */
 .found {
  border-color: #00b409;
 }

 .not-found {
  border-color: #f44336;
 }

 /* Estilos de Informa√ß√£o da M√∫sica */
 .result-title {
  color: #00b409;
  font-size: 1.3em;
  font-weight: bold;
  margin-bottom: 10px;
 }

 .track-details p {
  margin: 5px 0;
  line-height: 1.4;
 }

 .data-warning {
  color: #b3b3b3;
  font-size: 0.9em;
  margin-top: 10px;
 }

 /* --- NOVO CSS PARA VISUALIZADOR DE BUSCA BIN√ÅRIA --- */

 #search-range-display {
  margin-top: 20px;
  background-color: #1a1a1a;
  border: 1px solid #222222;
  border-radius: 8px;
  padding: 15px;
 }

 .range-bar {
  height: 20px;
  background-color: #282828;
  border-radius: 2px;
  position: relative;
  margin-bottom: 15px;
  overflow: hidden;
 }

 #current-range {
  position: absolute;
  height: 100%;
  background-color: #00b409; /* Cor verde para o intervalo ativo */
  transition: left 0.5s ease-out, width 0.5s ease-out;
  opacity: 0.6;
 }

 .range-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.8em;
  color: #b3b3b3;
 }

 #mid-point-marker {
  position: absolute;
  top: -5px;
  width: 4px;
  height: 30px;
  background-color: #f44336; /* Marcador vermelho para o ponto m√©dio */
  border-radius: 2px;
  transition: left 0.5s ease-out;
 }

 #mid-point-text {
  position: absolute;
  top: 30px;
  color: #f44336;
  font-size: 0.7em;
  font-weight: bold;
  transition: left 0.5s ease-out;
  transform: translateX(-50%);
 }

 #step-info {
  margin-top: 10px;
  color: #f4f4f9;
  font-weight: bold;
  font-size: 1em;
 }
</style>

<div class="container-main">

 <div class="column-left">
  <div class="command-box">
   <p style="margin-top: 0; font-weight: bold;">Configura√ß√£o <strong>O(log N)</strong></p>
   <div class="controls">
    <label for="target">Buscar M√∫sica por ID:</label>
    <input type="text" id="target" value="" style="width: 300px; padding: 5px;"
     placeholder="Ex: ID da M√∫sica">
    <button id="startButton">Iniciar Busca Bin√°ria</button>
   </div>
  </div>

  <p id="totalRegistros">Carregando dados...</p>
  <p id="data-status" class="data-warning">O array de busca √© carregado <strong>ORDENADO</strong> pelo 'track_id'
   (requisito para a Busca Bin√°ria).</p>
 </div>


 <div class="column-right">
  <h2>Resultado da Busca:</h2>
  <p id="time-elapsed">Tempo de Busca: <strong>0 ms</strong></p>
  <p id="status-steps">Passos de Compara√ß√£o: <strong>0</strong> (Logar√≠tmico)</p>

  <div id="resultBox" class="result-box">
   <p id="status">Aguardando a busca...</p>
  </div>

  <h3>Representa√ß√£o Visual (O(log N)):</h3>
  <p style="color: #b3b3b3; font-size: 0.9em;">A barra mostra como o algoritmo elimina metade do espa√ßo de busca a cada passo.</p>

  <div id="search-range-display">
   <div class="range-bar">
    <div id="current-range"></div>
    <div id="mid-point-marker"></div>
    <div id="mid-point-text"></div>
   </div>
   <div class="range-label">
    <span id="start-index">In√≠cio (0)</span>
    <span id="end-index">Fim (N-1)</span>
   </div>
   <div id="step-info">Aguardando...</div>
  </div>
 </div>

</div>

<script>
 // VARI√ÅVEIS DE ESCOPO GLOBAL
 let rawData = [];
 let isSearching = false;

 // Refer√™ncias dos elementos visuais
 const currentRangeElement = document.getElementById('current-range');
 const midPointMarker = document.getElementById('mid-point-marker');
 const midPointText = document.getElementById('mid-point-text');
 const stepInfo = document.getElementById('step-info');
 const startIndexDisplay = document.getElementById('start-index');
 const endIndexDisplay = document.getElementById('end-index');


 // 1. LEITURA DE DADOS
 const scriptElement = document.getElementById('spotify-data');
 if (scriptElement && scriptElement.textContent.trim().length > 0) {
  try {
   rawData = JSON.parse(scriptElement.textContent);
  } catch (e) {
   console.error("Erro fatal: N√£o foi poss√≠vel processar os dados do servidor.", e);
  }
 }

 /**
 * Atualiza o box de resultado com a informa√ß√£o formatada.
 */
 function displayResult(statusText, steps, success = true, music = null, duration = 0) {
  const resultBox = document.getElementById('resultBox');
  const timeElapsed = document.getElementById('time-elapsed');
  const statusSteps = document.getElementById('status-steps');

  timeElapsed.innerHTML = `Tempo de Busca: <strong>${duration.toFixed(3)} ms</strong>`;
  statusSteps.innerHTML = `Passos de Compara√ß√£o: <strong>${steps}</strong>`;

  let htmlContent = '';

  if (success && music) {
   htmlContent = `
  <p class="result-title">‚úÖ M√∫sica ENCONTRADA!</p>
  <div class="track-details">
   <p><strong>T√≠tulo:</strong> ${music.track_name}</p>
   <p><strong>Artista:</strong> ${music.track_artist}</p>
   <p><strong>Popularidade:</strong> ${music.track_popularity}</p>
      <p style="font-size: 0.8em; color: #b3b3b3;">ID: ${music.track_id}</p>
  </div>
  `;
  } else {
   htmlContent = `<p class="not-found">‚ùå ${statusText}</p>`;
  }

  resultBox.innerHTML = htmlContent;

  resultBox.classList.remove('found', 'not-found');
  resultBox.classList.add(success ? 'found' : 'not-found');
 }

 function resetSearch() {
  isSearching = false;
  document.getElementById('time-elapsed').innerHTML = `Tempo de Busca: <strong>0 ms</strong>`;
  document.getElementById('status-steps').innerHTML = `Passos de Compara√ß√£o: <strong>0</strong> (Logar√≠tmico)`;
  document.getElementById('resultBox').innerHTML = '<p id="status">Aguardando a busca...</p>';
  document.getElementById('resultBox').classList.remove('found', 'not-found');
  
  // Reset visualizador
  currentRangeElement.style.width = '100%';
  currentRangeElement.style.left = '0%';
  midPointMarker.style.left = '-5%'; // Esconde o marcador
  midPointText.textContent = '';
  stepInfo.textContent = 'Pronto para buscar...';
  startIndexDisplay.textContent = `In√≠cio (0)`;
  endIndexDisplay.textContent = `Fim (${rawData.length - 1})`;
 }

 /**
 * FUN√á√ÉO DE ATUALIZA√á√ÉO VISUAL (Chamada a cada passo do loop)
 */
 async function updateBinaryVisual(left, right, mid, currentId, targetId, totalSize, steps) {
  const rangeLength = right - left + 1;
  const totalLength = totalSize;

  // Calcula a posi√ß√£o e largura do intervalo atual em porcentagem
  const rangeWidth = (rangeLength / totalLength) * 100;
  const rangeLeft = (left / totalLength) * 100;
  
  // Calcula a posi√ß√£o do ponto m√©dio em porcentagem (mid / totalLength)
  const midPosition = (mid / totalLength) * 100;

  currentRangeElement.style.width = `${rangeWidth}%`;
  currentRangeElement.style.left = `${rangeLeft}%`;
  midPointMarker.style.left = `${midPosition}%`;
  midPointText.style.left = `${midPosition}%`;
  
  startIndexDisplay.textContent = `In√≠cio (${left})`;
  endIndexDisplay.textContent = `Fim (${right})`;

  // Adiciona feedback sobre a compara√ß√£o
  let comparisonText = '';
  const comparison = currentId.localeCompare(targetId);

  if (comparison === 0) {
   comparisonText = `ENCONTRADO!`;
  } else if (comparison < 0) {
   comparisonText = `M√∫sica atual (${currentId}) < Alvo. Buscando √† DIREITA.`;
  } else {
   comparisonText = `M√∫sica atual (${currentId}) > Alvo. Buscando √† ESQUERDA.`;
  }

  stepInfo.innerHTML = `**Passo ${steps}:** Comparando √çndice ${mid}. ${comparisonText}`;
  midPointText.textContent = `MID: ${mid}`;

  // Pequeno atraso para visualiza√ß√£o
  await new Promise(resolve => setTimeout(resolve, 500)); 
 }

 /**
 * Algoritmo de Busca Bin√°ria (com visualiza√ß√£o)
 */
 async function binarySearchVisual(arr, targetId) {
  let left = 0;
  let right = arr.length - 1;
  let steps = 0;
  let foundMusic = null;

  while (left <= right) {
   steps++;
   let mid = Math.floor((left + right) / 2);
   const currentId = arr[mid].track_id;

   // Visualiza o passo atual
   await updateBinaryVisual(left, right, mid, currentId, targetId, arr.length, steps);

   // Compara√ß√£o de strings (IDs) usando localeCompare
   const comparison = currentId.localeCompare(targetId);

   if (comparison === 0) { // IDs s√£o iguais
    foundMusic = arr[mid];
    break;
   } else if (comparison < 0) { // O ID atual √© menor (vem antes), ent√£o a busca vai para a direita
    left = mid + 1;
   } else { // O ID atual √© maior (vem depois), ent√£o a busca vai para a esquerda
    right = mid - 1;
   }
  }
  
  // Ajuste final do visual caso n√£o encontre
  if (!foundMusic) {
   stepInfo.innerHTML = `**Busca Finalizada:** M√∫sica n√£o encontrada em ${steps} passos.`;
   currentRangeElement.style.width = '0%';
   midPointMarker.style.left = '-5%'; // Esconde
   midPointText.textContent = '';
  }

  return {
   music: foundMusic,
   steps: steps
  };
 }

 async function startSearch() {
  if (isSearching || rawData.length === 0) return;

  isSearching = true;
  resetSearch();

  const targetId = document.getElementById('target').value.trim();

  document.getElementById('status').textContent = `Iniciando Busca Indexada (Bin√°ria) para ID: ${targetId}...`;

  const startTime = performance.now();
  
  // Executa a busca com visualiza√ß√£o
  const { music, steps } = await binarySearchVisual(rawData, targetId);
  
  const endTime = performance.now();
  const duration = endTime - startTime;


  if (music) {
   displayResult(`M√∫sica ENCONTRADA!`, steps, true, music, duration);
  } else {
   displayResult(`M√∫sica com ID "${targetId}" N√ÉO ENCONTRADA.`, steps, false, null, duration);
  }

  isSearching = false;
 }


 // 2. EVENTO DE CARREGAMENTO DA P√ÅGINA
 document.addEventListener('DOMContentLoaded', () => {
  
  // --- PASSO CR√çTICO: ORDENA√á√ÉO DO ARRAY ---
  if (rawData.length > 0) {
   // Ordena o array por track_id usando localeCompare para strings
   rawData.sort((a, b) => a.track_id.localeCompare(b.track_id));
  }
  // ---------------------------------------------
  
  document.getElementById('totalRegistros').textContent = `Total de M√∫sicas no Banco (Estrutura Ordenada): ${rawData.length}`;

  // Define um ID de exemplo (o primeiro ID ap√≥s a ordena√ß√£o)
  if (rawData.length > 0) {
   document.getElementById('target').value = rawData[Math.floor(rawData.length * 0.75)].track_id; // Exemplo no meio-direito
   startIndexDisplay.textContent = `In√≠cio (0)`;
   endIndexDisplay.textContent = `Fim (${rawData.length - 1})`;
  } else {
   document.getElementById('target').value = 'Verifique a View/Popula√ß√£o';
  }

  // Anexa a fun√ß√£o startSearch() ao clique do bot√£o
  const startButton = document.getElementById('startButton');
  if (startButton) {
   startButton.addEventListener('click', startSearch);
  }
  
  resetSearch(); // Inicializa o visualizador no DOMContentLoaded
 });
</script>

{% endblock content %}