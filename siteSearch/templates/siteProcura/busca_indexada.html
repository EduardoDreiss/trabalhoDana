{% extends 'base.html' %} {% block title %}Filtragem por ClassificaÃ§Ã£o |
CatÃ¡logo Premium{%endblock %} {% block content %} {{
dados_para_js|json_script:"spotify-data" }}

<h1 style="color: #00b409">
  ðŸ“Š Filtragem por ClassificaÃ§Ã£o: GÃªnero e Artista
  <hr style="border-color: #333333" />
</h1>
<p>
  Explore nosso catÃ¡logo filtrando por categorias. Selecione um
  <strong>GÃªnero</strong>, refine pelo <strong>Artista</strong> e encontre a
  faixa desejada.
</p>

<style>
  .container-main {
    display: flex;
    gap: 40px;
    margin-top: 30px;
  }

  .column-left {
    flex: 0 0 350px;
  }

  .column-right {
    flex: 1;
  }

  .command-box {
    border: 1px solid #222;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background-color: #1a1a1a;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  }

  strong {
    color: #00b409;
  }

  .controls {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .controls label {
    color: #e0e0e0;
    margin-bottom: 0;
    font-weight: 700;
    display: block;
    font-size: 0.9em;
  }

  .controls select {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #333;
    background-color: #242424;
    color: #fff;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300b409%22%20d%3D%22M287%2C79.4L146.2%2C220.2L5.4%2C79.4c-8.9-8.9-23.2-8.9-32.1%2C0c-8.9%2C8.9-8.9%2C23.2%2C0%2C32.1l156%2C156c4.5%2C4.5%2C10.4%2C6.7%2C16.1%2C6.7c5.7%2C0%2C11.5-2.2%2C16.1-6.7l156-156c8.9-8.9%2C8.9-23.2%2C0-32.1C310.2%2C70.5%2C295.9%2C70.5%2C287%2C79.4z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat;
    background-position: right 10px top 50%;
    background-size: 0.6em auto;
  }

  .controls select:focus,
  .controls input:focus {
    border-color: #00b409;
    outline: none;
  }

  .controls input {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #333;
    background-color: #242424;
    color: #fff;
  }

  .result-box {
    border: 1px solid #222;
    border-radius: 8px;
    padding: 20px;
    background-color: #1a1a1a;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    margin-top: 15px;
    min-height: 200px;
    max-height: 500px;
    overflow-y: auto;
  }

  .music-list-item {
    border-bottom: 1px solid #282828;
    padding: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.2s;
  }

  .music-list-item:hover {
    background-color: #1c1c1c;
  }

  .music-list-item:last-child {
    border-bottom: none;
  }

  .track-info-left {
    display: flex;
    flex-direction: column;
  }

  .track-name {
    color: #fff;
    font-weight: 600;
    font-size: 1.1em;
  }

  .track-artist {
    color: #b3b3b3;
    font-size: 0.9em;
  }

  .track-meta {
    font-size: 0.8em;
    color: #999;
    margin-top: 4px;
  }

  .status-message {
    color: #b3b3b3;
    font-style: italic;
  }

  .youtube-link {
    color: #fff;
    text-decoration: none;
    cursor: pointer;
    transition: color 0.2s;
    display: inline-flex;
    align-items: center;
  }

  .youtube-link:hover {
    color: #1ed760;
    text-decoration: underline;
  }

  .youtube-icon {
    color: #ff0000;
    font-size: 1.2em;
  }

  .result-box::-webkit-scrollbar {
    width: 8px;
    background-color: transparent;
  }

  .result-box::-webkit-scrollbar-thumb {
    background-color: #555;
    border-radius: 10px;
    border: 2px solid #1e1e1e;
  }

  .result-box::-webkit-scrollbar-thumb:hover {
    background-color: #777;
  }

  .result-box {
    scrollbar-width: thin;
    scrollbar-color: #555 #1e1e1e;
  }

  @media (max-width: 768px) {
    .container-main {
      flex-direction: column;
      gap: 20px;
      margin-top: 15px;
    }

    .column-left,
    .column-right {
      flex: 1 1 auto;
      min-width: 100%;
    }

    .command-box {
      padding: 15px;
    }

    .controls {
      gap: 10px;
    }
  }
</style>

<div class="container-main">
  <div class="column-left">
    <div class="command-box">
      <p style="margin-top: 0; font-weight: bold">1. Escolha a Categoria</p>
      <div class="controls">
        <div>
          <label for="genre-select">GÃªnero Principal:</label>
          <select id="genre-select">
            <option value="">Buscar por GÃªneros</option>
          </select>
        </div>
        <div>
          <label for="artist-input">Artista (Refinar - Digite ou Selecione):</label>
          <input type="text" id="artist-input" placeholder="Digite ou escolha o nome do Artista..."
            list="artist-options" />
          <datalist id="artist-options"></datalist>
        </div>
      </div>
    </div>
  </div>
  <div class="column-right">
    <h2>Resultados da ClassificaÃ§Ã£o:</h2>
    <div id="resultBox" class="result-box">
      <p class="status-message">Carregando...</p>
    </div>
  </div>
</div>

<script>
  let rawData = [];
  const indexedData = {};
  const artistList = new Set();

  const genreSelect = document.getElementById("genre-select");
  const artistInput = document.getElementById("artist-input");
  const artistDatalist = document.getElementById("artist-options");
  const resultBox = document.getElementById("resultBox");

  try {
    const scriptElement = document.getElementById("spotify-data");
    if (scriptElement && scriptElement.textContent.trim().length > 0) {
      rawData = JSON.parse(scriptElement.textContent);
    }
  } catch (e) {
    console.error("Erro ao processar dados JSON:", e);
  }

  function buildIndexes() {
    if (rawData.length === 0) {
      console.warn("âš ï¸ IndexaÃ§Ã£o nÃ£o iniciada: rawData estÃ¡ vazio.");
      return;
    }
    rawData.forEach((music) => {
      const genre = music.playlist_genre
        ? music.playlist_genre.trim()
        : "GÃªnero Desconhecido";
      const artist = music.track_artist
        ? music.track_artist.trim()
        : "Artista Desconhecido";

      if (
        genre === "GÃªnero Desconhecido" &&
        artist === "Artista Desconhecido"
      ) {
        return;
      }
      if (!indexedData[genre]) {
        indexedData[genre] = {};
      }
      if (!indexedData[genre][artist]) {
        indexedData[genre][artist] = [];
      }
      indexedData[genre][artist].push(music);
      if (artist !== "Artista Desconhecido") {
        artistList.add(artist);
      }
    });
  }

  function populateGenres() {
    genreSelect.innerHTML = '<option value="">Buscar por GÃªneros</option>';
    if (Object.keys(indexedData).length === 0) return;
    const sortedGenres = Object.keys(indexedData).sort();
    sortedGenres.forEach((genre) => {
      const artistCount = Object.keys(indexedData[genre]).length;
      const option = new Option(`${genre} (${artistCount} Artistas)`, genre);
      genreSelect.add(option);
    });
    genreSelect.disabled = false;
  }

  function populateArtistDatalist(artists) {
    artistDatalist.innerHTML = "";
    artists.forEach((artist) => {
      const option = document.createElement("option");
      option.value = artist;
      artistDatalist.appendChild(option);
    });
  }

  function displayArtists(genre) {
    if (!genre || !indexedData[genre]) {
      resultBox.innerHTML =
        '<p class="status-message">Selecione um GÃªnero para listar artistas.</p>';
      return;
    }
    const artistsData = indexedData[genre];
    const artists = Object.keys(artistsData).sort((a, b) => a.localeCompare(b));
    let htmlContent = `<p style="color:#00b409;font-weight:bold;">Artistas em ${genre}: ${artists.length}</p><div style="height:350px;overflow-y:auto;padding:5px;">`;
    artists.forEach((artist) => {
      const musicCount = artistsData[artist].length;
      htmlContent += `<div class="music-list-item" style="cursor:pointer;" onclick="selectArtistFromList('${artist.replace(
        /'/g,
        "\\'"
      )}')"><div class="track-info-left"><div class="track-name">${artist}</div><div class="track-artist">${musicCount} Faixas</div></div><div class="track-meta">Clique para Filtrar</div></div>`;
    });
    htmlContent += "</div>";
    resultBox.innerHTML = htmlContent;
  }

  window.selectArtistFromList = function (artistName) {
    artistInput.value = artistName;
    handleArtistChange();
  };

  function handleGenreChange() {
    const selectedGenre = genreSelect.value;
    artistInput.value = "";

    if (selectedGenre) {
      const artists = Object.keys(indexedData[selectedGenre]).sort();
      populateArtistDatalist(artists);
      displayArtists(selectedGenre);
    } else {
      populateArtistDatalist(Array.from(artistList).sort());

      if (artistInput.value.trim() === "") {
        displaySongs(rawData, "Todas as Faixas do CatÃ¡logo (Busca Geral)");
      } else {
        handleArtistChange();
      }
    }
  }

  function handleArtistChange() {
    const selectedGenre = genreSelect.value;
    const selectedArtist = artistInput.value.trim();

    if (!selectedGenre && !selectedArtist) {
      displaySongs(rawData, "Todas as Faixas do CatÃ¡logo");
      return;
    }

    resultBox.innerHTML = '<p class="status-message">Carregando...</p>';

    if (selectedGenre && selectedArtist) {
      const songs = indexedData[selectedGenre][selectedArtist];
      if (songs) {
        displaySongs(songs, `Faixas de ${selectedArtist} em ${selectedGenre}`);
      } else {
        resultBox.innerHTML = `<p class="status-message">Artista "${selectedArtist}" nÃ£o encontrado no gÃªnero ${selectedGenre}.</p>`;
      }
      return;
    } else if (!selectedGenre && selectedArtist) {
      const artistLower = selectedArtist.toLowerCase();
      const matchedSongs = rawData.filter(
        (song) =>
          song.track_artist &&
          song.track_artist.trim().toLowerCase() === artistLower
      );

      if (matchedSongs.length > 0) {
        displaySongs(
          matchedSongs,
          `Faixas encontradas de ${selectedArtist} (Busca em todos os GÃªneros)`
        );
      } else {
        resultBox.innerHTML = `<p class="status-message">Artista "${selectedArtist}" nÃ£o encontrado no catÃ¡logo.</p>`;
      }
      return;
    } else if (selectedGenre && !selectedArtist) {
      displayArtists(selectedGenre);
      return;
    }

    displaySongs(rawData);
  }

  function displaySongs(songs, title = "Todas as Faixas do CatÃ¡logo") {
    if (!songs || songs.length === 0) {
      resultBox.innerHTML =
        '<p class="status-message">Nenhuma faixa encontrada para essa seleÃ§Ã£o.</p>';
      return;
    }
    let htmlContent = `<p style="color:#b3b3b3;font-weight:bold;">${title}: ${songs.length}</p>`; /*monta o link para a mÃºsica*/
    songs.forEach((song) => {
      const popularity = song.track_popularity || "N/A";
      const trackName = song.track_name || "Nome Desconhecido";
      const artistName = song.track_artist || "Artista Desconhecido";
      const genre = song.playlist_genre || "GÃªnero Desconhecido";
      const searchTerm = `${trackName} ${artistName}`;
      const encodedSearch = encodeURIComponent(searchTerm);
      const youtubeUrl = `https://www.youtube.com/results?search_query=${encodedSearch}`;
      htmlContent += `<div class="music-list-item"><div class="track-info-left">
      <a href="${youtubeUrl}" target="_blank" class="youtube-link track-name">
        ${trackName}
        <span class="youtube-icon" style="color: #00b409; font-size: 0.9em; margin-left: 5px;">ðŸ”—</span>
      </a>
      <div class="track-artist">${artistName}</div>
      <div class="track-meta">GÃªnero: ${genre} | Pop: ${popularity}%</div>
    </div></div>`;
    });
    resultBox.innerHTML = htmlContent;
  }

  document.addEventListener("DOMContentLoaded", () => {
    buildIndexes();
    populateGenres();

    populateArtistDatalist(Array.from(artistList).sort());

    displaySongs(rawData);
    genreSelect.addEventListener("change", handleGenreChange);
    artistInput.addEventListener("input", handleArtistChange);
  });
</script>

{% endblock content %}