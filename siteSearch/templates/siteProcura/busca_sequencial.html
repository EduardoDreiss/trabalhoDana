{% extends 'base.html' %} 

{% block title %}Resultados da Busca | M√∫sica Spotify{%endblock %} {% block content %}

{{dados_para_js|json_script:"spotify-data" }}

<h1 style="color: #00b409">
  ¬†üîç Buscar M√∫sicas (Cat√°logo Spotify)
  <hr style="border-color: #282828" />
</h1>
<p>
  Digite o <strong>Nome da M√∫sica</strong> ou o <strong>Nome do Artista</strong> para encontrar
  rapidamente sua faixa no nosso cat√°logo.
</p>

<style>
  .container-main {
    display: flex;
    gap: 40px;
    margin-top: 30px;
  }

  .column-left {
    flex: 0 0 400px; /* Aumentado para melhor visualiza√ß√£o */
  }

  .column-right {
    flex: 1;
  }

  .controls {
    margin-bottom: 20px;
  }

  .command-box {
    border: 1px solid #222222;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background-color: #1a1a1a;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  }

  strong {
    color: #00b409;
  }

  button {
    background-color: #00b409;
    color: black;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    border: 1px solid #000000;
    transition: background-color 0.3s;
    margin-top: 10px;
  }
  button:hover {
    background-color: #1ed760;
  }

  .result-box {
    border: 1px solid #222222;
    border-radius: 8px;
    padding: 15px;
    background-color: #121212;
    color: #ffffff;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    margin-bottom: 20px;
  }

  .found {
    border-color: #1db954;
  }

  .not-found {
    border-color: #f44336;
  }

  .song-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .track-number {
    /* Usado para o √≠cone de Play/M√∫sica */
    font-weight: bold;
    font-size: 1.5em;
    color: #00b409;
  }

  .track-details p {
    margin: 0;
    line-height: 1.4;
  }

  .track-details .artist-name {
    color: #b3b3b3;
    font-size: 0.9em;
  }

  .result-title {
    color: #00b409;
    font-size: 1.1em;
    margin-bottom: 10px;
  }

  /* Reintroduzindo cor de destaque para o tempo */
  #time-elapsed strong {
    color: #00b409;
  }

  /* responsividade */
  @media (max-width: 768px) {
    .container-main {
      flex-direction: column;
      gap: 20px;
      margin-top: 15px;
    }

    .column-left {
      flex: 1 1 auto;
      min-width: 100%;
    }

    .controls {
      display: flex;
      flex-direction: column;
    }

    .controls label {
      margin-bottom: 5px;
    }

    .controls input {
      width: 100% !important;
      box-sizing: border-box;
    }

    .controls button {
      width: 100%;
      margin-top: 15px;
    }

    .column-right {
      flex: 1 1 auto;
    }
  }
</style>

<div class="container-main">
  <div class="column-left">
    <div class="command-box">
      <p style="margin-top: 0">
        <strong>Pesquisa R√°pida no Cat√°logo</strong>
      </p>
      <div class="controls">
        <label for="target">Buscar por Nome da M√∫sica ou Artista:</label>
        <input
          type="text"
          id="target"
          value=""
          style="width: 380px; padding: 5px"
          placeholder="Ex: nome da m√∫sica ou artista"
        />
        <button onclick="startSearch()">Buscar</button>
      </div>
    </div>

    <p id="totalRegistros" style="margin-top: 20px">Carregando dados...</p>
  </div>

  <div class="column-right">
    <h2>Resultados:</h2>

    <p id="time-elapsed">Tempo de Busca: <strong>0 ms</strong></p>

    <div id="resultBox" class="result-box">
      <p id="status">Aguardando sua busca...</p>
    </div>
  </div>
</div>
<script>
  // LEITURA DE DADOS SEGURA
  let rawData = [];
  const scriptElement = document.getElementById("spotify-data");

  if (scriptElement && scriptElement.textContent.trim().length > 0) {
    try {
      rawData = JSON.parse(scriptElement.textContent);
    } catch (e) {
      console.error(
        "Erro fatal: N√£o foi poss√≠vel processar os dados do servidor.",
        e
      );
    }
  }

  let isSearching = false;

  // currentTrackDisplay (mock) mantido para evitar erros no JS que n√£o foi totalmente removido
  const currentTrackDisplay = { innerHTML: "Pronto para buscar..." };

  document.addEventListener("DOMContentLoaded", () => {
    // CORRE√á√ÉO PRINCIPAL: Declarar targetInput
    const targetInput = document.getElementById("target");
    const totalRecordsDisplay = document.getElementById("totalRegistros");

    totalRecordsDisplay.innerHTML = `Total de M√∫sicas no nosso Cat√°logo: <strong>${rawData.length}</strong>`;

    // Sugere um valor inicial para teste
    if (rawData.length > 0) {
      targetInput.value = rawData[0].track_artist;
    } else {
      targetInput.value = "ERRO: Sem dados";
    }

    // Adiciona o listener para a tecla Enter
    targetInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter" || event.keyCode === 13) {
        event.preventDefault();
        startSearch();
      }
    });
  });

  function displayResult(
    statusText,
    comparacoes,
    success = true,
    musica = null,
    duration = 0
  ) {
    const resultBox = document.getElementById("resultBox");

    const timeElapsed = document.getElementById("time-elapsed");
    timeElapsed.innerHTML = `Tempo de Busca: <strong>${duration.toFixed(
      3
    )} ms</strong>`;

    let htmlContent = "";

    if (!musica) {
      // Tratamento de M√∫sica N√£o Encontrada
      resultBox.innerHTML = `<p class="not-found">‚ùå ${statusText}</p>`;
      resultBox.classList.remove("found");
      resultBox.classList.add("not-found");
      return;
    }

    // Extrair campos
    const genero = musica.playlist_genre || "G√™nero Desconhecido";
    const popularidade = musica.track_popularity || "N/A";

    // L√≥gica para formatar Dura√ß√£o (duration_ms) para MM:SS
    const duracaoMs = musica.duration_ms || 0;
    let duracaoFormatada = "N/A";

    if (duracaoMs > 0) {
      const minutos = Math.floor(duracaoMs / 60000);
      const segundos = Math.round((duracaoMs % 60000) / 1000);
      // Garante formato MM:SS
      duracaoFormatada = minutos + ":" + (segundos < 10 ? "0" : "") + segundos;
    }

    // Construir o HTML com todos os detalhes (√çcone de m√∫sica em vez de n√∫mero)
    if (success) {
      htmlContent = `
<p class="result-title">‚úÖ Encontramos o resultado principal!</p>
<div class="song-info">
<span class="track-number">üéß</span>
<div class="track-details">
<p><strong>${musica.track_name}</strong></p>
<p class="artist-name">Artista: ${musica.track_artist}</p>
<p class="artist-name">
    G√™nero: <strong>${genero}</strong> | 
    Popularidade: ${popularidade}% | 
    Dura√ß√£o: ${duracaoFormatada} 
  </p>
</div>
</div>
`;
    } else {
      htmlContent = `<p class="not-found">‚ùå ${statusText}</p>`;
    }

    resultBox.innerHTML = htmlContent;

    resultBox.classList.remove("found", "not-found");
    if (success) {
      resultBox.classList.add("found");
    } else {
      resultBox.classList.add("not-found");
    }
  }

  function updateProgressBar(steps, total) {}

  function resetSearch() {
    isSearching = false;

    document.getElementById(
      "time-elapsed"
    ).innerHTML = `Tempo de Busca: <strong>0 ms</strong>`;

    document.getElementById("resultBox").innerHTML =
      '<p id="status">Aguardando sua busca...</p>';
    document.getElementById("resultBox").classList.remove("found", "not-found");
  }

  async function startSearch() {
    if (isSearching || rawData.length === 0) return;

    isSearching = true;
    resetSearch();

    // Limpa e normaliza a consulta
    const query = document.getElementById("target").value.trim().toLowerCase();

    if (query.length < 1) {
      displayResult(
        "Por favor, digite o nome de uma m√∫sica ou artista para buscar.",
        0,
        false
      );
      isSearching = false;
      return;
    }

    const totalData = rawData.length;
    let found = false;
    let steps = 0;
    const startTime = performance.now();
    let endTime = 0;

    for (let i = 0; i < totalData; i++) {
      steps++;
      const currentMusic = rawData[i];

      // Normaliza o nome da m√∫sica e artista para compara√ß√£o
      const trackName = currentMusic.track_name.toLowerCase();
      const artistName = currentMusic.track_artist.toLowerCase();

      // Condi√ß√£o de busca: a query √© substring do nome da m√∫sica OU do nome do artista
      const isMatch = trackName.includes(query) || artistName.includes(query);

      // Remo√ß√£o da parte de atualiza√ß√£o visual passo a passo (mantida)

      if (isMatch) {
        // Regra da Busca Sequencial: Para no primeiro que der match
        endTime = performance.now();
        const musica = currentMusic;
        const duration = endTime - startTime;

        displayResult(`M√∫sica ENCONTRADA!`, steps, true, musica, duration);
        found = true;
        break; // Interrompe a busca sequencial
      }
    }

    if (!found) {
      endTime = performance.now();
      const duration = endTime - startTime;
      displayResult(
        `N√£o encontramos resultados para "${document
          .getElementById("target")
          .value.trim()}" no cat√°logo.`,
        steps,
        false,
        null,
        duration
      );
    }

    isSearching = false;
  }
</script>

{% endblock content %}
