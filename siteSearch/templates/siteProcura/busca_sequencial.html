{% extends 'base.html' %} 

{% block title %}Busca Sequencial por Nome/Artista | M√∫sicas Spotify{%endblock %} 

{% block content %} 

{{dados_para_js|json_script:"spotify-data" }}

<h1 style="color: #00b409">
  ¬†üéµ Busca Sequencial (Dataset Spotify)
  <hr style="border-color: #282828" />
</h1>
<p>
  Objetivo: Demonstra√ß√£o da complexidade <strong>O(N)</strong>, onde o sistema
  busca sequencialmente pelo <strong>Nome da M√∫sica</strong> ou
  <strong>Nome do Artista</strong>. A busca √© interrompida no primeiro resultado
  encontrado.
</p>

<style>
  .container-main {
    display: flex;
    gap: 40px;
    margin-top: 30px;
  }

  .column-left {
    flex: 0 0 400px; /* Aumentado para melhor visualiza√ß√£o */
  }

  .column-right {
    flex: 1;
  }

  .controls {
    margin-bottom: 20px;
  }

  .command-box {
    border: 1px solid #222222;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background-color: #1a1a1a;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  }

  ¬†strong {
    color: #00b409;
  }

  ¬†button {
    background-color: #00b409;
    color: black;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    border: 1px solid #000000;
    transition: background-color 0.3s;
    margin-top: 10px;
  }
  ¬†button:hover {
    background-color: #1ed760;
  }

  .result-box {
    border: 1px solid #222222;
    border-radius: 8px;
    padding: 15px;
    background-color: #121212;
    color: #ffffff;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    margin-bottom: 20px;
  }

  .found {
    border-color: #1db954;
  }

  .not-found {
    border-color: #f44336;
  }

  .song-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .track-number {
    font-weight: bold;
    font-size: 1.5em;
    color: #00b409;
  }

  .track-details p {
    margin: 0;
    line-height: 1.4;
  }

  .track-details .artist-name {
    color: #b3b3b3;
    font-size: 0.9em;
  }

  .result-title {
    color: #00b409;
    font-size: 1.1em;
    margin-bottom: 10px;
  }

  #status-steps strong,
  #time-elapsed strong {
    color: #00b409;
  }

  /* --- CSS PARA A BARRA DE PROGRESSO VISUAL --- */
  .progress-visualizer {
    width: 100%;
    background-color: #282828;
    border-radius: 4px;
    overflow: hidden;
    height: 25px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
    margin-bottom: 10px;
  }

  .progress-bar {
    height: 100%;
    width: 0;
    background-color: #00b409;
    transition: width 0.8s ease-out;
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }

  .progress-text {
    color: black;
    font-weight: bold;
    font-size: 0.9em;
    padding: 0 10px;
  }

  #current-track-display {
    margin-top: 15px;
    padding: 10px;
    background-color: #1a1a1a;
    border: 1px solid #222222;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9em;
    color: #e0e0e0;
    min-height: 20px;
  }

  /* responsividade */
  @media (max-width: 768px) {
    .container-main {
      flex-direction: column;
      gap: 20px;
      margin-top: 15px;
    }

    .column-left {
      flex: 1 1 auto;
      min-width: 100%;
    }

    .controls {
      display: flex;
      flex-direction: column;
    }

    .controls label {
      margin-bottom: 5px;
    }

    .controls input {
      width: 100% !important;
      box-sizing: border-box;
    }

    .controls button {
      width: 100%;
      margin-top: 15px;
    }

    .column-right {
      flex: 1 1 auto;
    }
  }
</style>

<div class="container-main">
  <div class="column-left">
    <div class="command-box">
      <p style="margin-top: 0">
        <strong>Busca Sequencial por Nome/Artista (O(N))</strong>
      </p>
      <div class="controls">
        <label for="target">Buscar por Nome da M√∫sica ou Artista:</label>
        <input
          type="text"
          id="target"
          value=""
          style="width: 380px; padding: 5px"
          placeholder="Ex: nome da m√∫sica ou artista"
        />
        <button onclick="startSearch()">Iniciar Busca Sequencial</button>
      </div>
    </div>

    <p id="totalRegistros" style="margin-top: 20px">Carregando dados...</p>
  </div>

  <div class="column-right">
    <h2>Resultado da Busca:</h2>
    <p id="status-steps">Aguardando a busca...</p>
    <p id="time-elapsed">Tempo de Busca: <strong>0 ms</strong></p>

    <div id="resultBox" class="result-box">
      <p id="status">Aguardando a busca...</p>
    </div>

    <h3>Representa√ß√£o Visual (O(N)):</h3>
    <p style="color: #b3b3b3; font-size: 0.9em">
      A barra indica o percentual do cat√°logo que precisou ser varrido.
    </p>
    <div class="progress-visualizer">
      <div id="progressBar" class="progress-bar">
        <span id="progressText" class="progress-text">0%</span>
      </div>
    </div>

    <p style="margin-top: 20px">
      <strong>M√∫sica sendo Verificada (Passo a Passo):</strong>
    </p>
    <div id="current-track-display">Pronto para buscar...</div>
  </div>
</div>
<script>
  // LEITURA DE DADOS SEGURA
  let rawData = [];
  const scriptElement = document.getElementById("spotify-data");

  if (scriptElement && scriptElement.textContent.trim().length > 0) {
    try {
      rawData = JSON.parse(scriptElement.textContent);
    } catch (e) {
      console.error(
        "Erro fatal: N√£o foi poss√≠vel processar os dados do servidor.",
        e
      );
    }
  }

  let isSearching = false;

  // Refer√™ncias
  const currentTrackDisplay = document.getElementById("current-track-display");

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById(
      "totalRegistros"
    ).textContent = `Total de M√∫sicas no Banco: ${rawData.length}`;

    // Sugere um valor inicial para teste
    if (rawData.length > 0) {
      document.getElementById("target").value = rawData[0].track_artist;
    } else {
      document.getElementById("target").value = "ERRO: Sem dados";
    }
  });

  // ----------------------------------------------------------------------------------
  // FUN√á√ïES DE DISPLAY
  // ----------------------------------------------------------------------------------

  function displayResult(
    statusText,
    comparacoes,
    success = true,
    musica = null,
    duration = 0
  ) {
    const resultBox = document.getElementById("resultBox");
    const statusSteps = document.getElementById("status-steps");
    const timeElapsed = document.getElementById("time-elapsed");

    statusSteps.innerHTML = `Total de Compara√ß√µes (Passos): <strong>${comparacoes}</strong>`;
    timeElapsed.innerHTML = `Tempo de Busca: <strong>${duration.toFixed(
      3
    )} ms</strong>`;

    let htmlContent = "";

    if (!musica) {
      // Tratamento de M√∫sica N√£o Encontrada
      resultBox.innerHTML = `<p class="not-found">‚ùå ${statusText}</p>`;
      resultBox.classList.remove("found");
      resultBox.classList.add("not-found");
      return;
    }

    // Extrair campos corrigidos
    const genero = musica.playlist_genre || "N/A";
    const popularidade = musica.track_popularity || "N/A";

    // NOVO: L√≥gica para formatar Dura√ß√£o (duration_ms) para MM:SS
    const duracaoMs = musica.duration_ms || 0;
    let duracaoFormatada = "N/A";

    if (duracaoMs > 0) {
      const minutos = Math.floor(duracaoMs / 60000);
      const segundos = Math.round((duracaoMs % 60000) / 1000);
      // Garante formato MM:SS
      duracaoFormatada = minutos + ":" + (segundos < 10 ? "0" : "") + segundos;
    }

    // Construir o HTML com todos os detalhes
    if (success) {
      htmlContent = `
<p class="result-title">‚úÖ M√∫sica ENCONTRADA!</p>
<div class="song-info">
<span class="track-number">1</span>
<div class="track-details">
<p><strong>${musica.track_name}</strong></p>
<p class="artist-name">${musica.track_artist}</p>
<p class="artist-name">
        G√™nero: <strong>${genero}</strong> | 
        Pop: ${popularidade} | 
        Dura√ß√£o: ${duracaoFormatada} 
    </p>
</div>
</div>
`;
    } else {
      htmlContent = `<p class="not-found">‚ùå ${statusText}</p>`;
    }

    resultBox.innerHTML = htmlContent;

    resultBox.classList.remove("found", "not-found");
    if (success) {
      resultBox.classList.add("found");
    } else {
      resultBox.classList.add("not-found");
    }
  }

  function updateProgressBar(steps, total) {
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    let percentage = total === 0 ? 0 : (steps / total) * 100;

    if (
      steps === total &&
      !document.getElementById("resultBox").classList.contains("found")
    ) {
      percentage = 100;
    }

    percentage = Math.min(100, percentage);

    progressBar.style.width = `${percentage.toFixed(2)}%`;
    progressText.textContent = `${percentage.toFixed(0)}%`;
  }

  function resetSearch() {
    isSearching = false;
    document.getElementById("status-steps").textContent =
      "Aguardando a busca...";
    document.getElementById(
      "time-elapsed"
    ).innerHTML = `Tempo de Busca: <strong>0 ms</strong>`;
    document.getElementById("resultBox").innerHTML =
      '<p id="status">Aguardando a busca...</p>';
    document.getElementById("resultBox").classList.remove("found", "not-found");

    updateProgressBar(0, 1);
    currentTrackDisplay.innerHTML = "Pronto para buscar...";
  }

  // ----------------------------------------------------------------------------------
  // 2. L√ìGICA DA BUSCA SEQUENCIAL (Nome da M√∫sica ou Artista)
  // ----------------------------------------------------------------------------------

  async function startSearch() {
    if (isSearching || rawData.length === 0) return;

    isSearching = true;
    resetSearch();

    // Limpa e normaliza a consulta
    const query = document.getElementById("target").value.trim().toLowerCase();

    if (query.length < 1) {
      displayResult(
        "Por favor, digite o nome de uma m√∫sica ou artista para buscar.",
        0,
        false
      );
      isSearching = false;
      return;
    }

    const totalData = rawData.length;
    let found = false;
    let steps = 0;
    const startTime = performance.now();
    let endTime = 0;

    for (let i = 0; i < totalData; i++) {
      steps++;
      const currentMusic = rawData[i];

      // Normaliza o nome da m√∫sica e artista para compara√ß√£o
      const trackName = currentMusic.track_name.toLowerCase();
      const artistName = currentMusic.track_artist.toLowerCase();

      // Condi√ß√£o de busca: a query √© substring do nome da m√∫sica OU do nome do artista
      const isMatch = trackName.includes(query) || artistName.includes(query);

      if (steps % 100 === 0 || i === 0 || i === totalData - 1 || isMatch) {
        currentTrackDisplay.innerHTML = `Verificando #${i}: <strong>${currentMusic.track_name}</strong> por ${currentMusic.track_artist}`;

        document.getElementById(
          "status-steps"
        ).textContent = `Passo ${steps}: Verificando...`;
        updateProgressBar(steps, totalData);

        // Adiciona um pequeno delay para visualiza√ß√£o do passo a passo
        if (!isMatch) {
          await new Promise((resolve) => setTimeout(resolve, 5));
        }
      }

      if (isMatch) {
        // Regra da Busca Sequencial: Para no primeiro que der match
        endTime = performance.now();
        const musica = currentMusic;
        const duration = endTime - startTime;

        displayResult(
          `M√∫sica ENCONTRADA! (no √≠ndice ${i})`,
          steps,
          true,
          musica,
          duration
        );
        currentTrackDisplay.innerHTML = `‚úÖ ENCONTRADO em ${steps} passos: <strong>${musica.track_name}</strong>`;
        found = true;
        break; // Interrompe a busca sequencial
      }
    }

    if (!found) {
      endTime = performance.now();
      const duration = endTime - startTime;
      displayResult(
        `"${document
          .getElementById("target")
          .value.trim()}" N√ÉO ENCONTRADO em todo o cat√°logo.`,
        steps,
        false,
        null,
        duration
      );
      currentTrackDisplay.innerHTML = `‚ùå Varredura Completa: Nada encontrado ap√≥s ${steps} passos.`;
    }

    updateProgressBar(steps, totalData);

    isSearching = false;
  }
</script>

{% endblock content %}
