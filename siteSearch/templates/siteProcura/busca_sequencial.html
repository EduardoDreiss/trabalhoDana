{% extends 'base.html' %} 

{% block title %}Pesquisa R√°pida | Cat√°logo de M√∫sicas{%endblock %} {% block content %}

{{dados_para_js|json_script:"spotify-data" }}

<h1 style="color: #00b409">
  üé∂ Encontre sua M√∫sica Favorita
  <hr style="border-color: #282828" />
</h1>
<p>
  Digite o <strong>T√≠tulo da M√∫sica</strong> ou o
  <strong>Nome do Artista</strong> abaixo. Nosso sistema busca no cat√°logo e
  exibe o resultado principal.
</p>

<style>
  /* Estilos Gerais e Layout */
  .container-main {
    display: flex;
    gap: 40px;
    margin-top: 30px;
  }

  .column-left {
    flex: 0 0 400px;
  }

  .column-right {
    flex: 1;
  }

  /* Estilos da Caixa de Comando (Busca) */
  .command-box {
    border: 1px solid #222222;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 20px;
    background-color: #1a1a1a;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.5);
  }
  ¬†strong {
    color: #00b409;
  }

  .controls {
    margin-top: 10px;
    display: flex;
    flex-direction: column;
  }

  .controls input {
    /* Melhorando a est√©tica do input */
    width: 100% !important;
    /* üëà CORRE√á√ÉO: Garante que o padding e a borda n√£o aumentem a largura total */
    box-sizing: border-box;

    padding: 12px 15px;
    margin-top: 5px;
    border-radius: 8px;
    border: 1px solid #444;
    background-color: #333;
    color: white;
    font-size: 1.1em;
    transition: border-color 0.3s;
  }
  .controls input:focus {
    border-color: #00b409;
    outline: none;
  }

  /* Estilos do Bot√£o */
  button {
    background-color: #00b409;
    color: black;
    font-weight: bold;
    border: none;
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.1s;
    margin-top: 15px;
    font-size: 1.1em;
  }
  button:hover {
    background-color: #1ed760;
    transform: translateY(-1px);
  }
  button:disabled {
    background-color: #555;
    cursor: not-allowed;
  }

  /* Estilos da Caixa de Resultado */
  .result-box {
    border: 1px solid #222222;
    border-radius: 12px;
    padding: 20px;
    background-color: #121212;
    color: #ffffff;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    margin-top: 15px;
    min-height: 100px;
    display: flex;
    align-items: center;
  }

  .found {
    border-color: #1db954;
  }

  .not-found {
    border-color: #f44336;
  }

  /* Status e Tempo de Busca */
  #time-elapsed {
    font-size: 0.9em;
    color: #b3b3b3;
    text-align: right;
    margin-bottom: -10px;
    margin-top: 10px;
  }
  #time-elapsed strong {
    color: #00b409;
  }

  strong{
    color:#00b409;
  }

  #totalRegistros {
    color: #b3b3b3;
    font-size: 0.9em;
  }

  /* Informa√ß√µes da M√∫sica */
  .song-info {
    display: flex;
    align-items: center;
    gap: 20px;
    width: 100%;
  }
  .track-number {
    font-size: 2.2em;
    line-height: 1;
  }
  .track-details p {
    margin: 4px 0;
    line-height: 1.4;
  }
  .track-details strong {
    color: #ffffff;
    font-size: 1.2em;
  }
  .track-details .artist-name {
    color: #b3b3b3;
    font-size: 1em;
  }
  .result-title {
    margin: 0;
    font-size: 1em;
    color: #1db954;
  }

  /* Indicador de Loading */
  .loading-status {
    color: #1ed760;
    font-style: italic;
  }

  /* responsividade */
  @media (max-width: 768px) {
    .container-main {
      flex-direction: column;
      gap: 20px;
    }
    .column-left {
      flex: 1;
      min-width: 100%;
    }
    .controls input,
    .controls button {
      width: 100% !important;
      box-sizing: border-box;
    }
  }
</style>

<div class="container-main">
  <div class="column-left">
    <div class="command-box">
      <p style="margin-top: 0">
        <strong>Busca Instant√¢nea</strong>
      </p>
      <div class="controls">
        <label for="target">O que voc√™ gostaria de ouvir hoje?</label>
        <input
          type="text"
          id="target"
          value=""
          placeholder="Ex: Do I Wanna Know? ou Arctic Monkeys"
        />
        <button id="searchButton" onclick="startSearch()">Buscar</button>
      </div>
    </div>

    <p id="totalRegistros">Carregando dados...</p>
  </div>

  <div class="column-right">
    <h2>Resultados:</h2>

    <p id="time-elapsed" style="display: none">
      Tempo de Busca: <strong>0 ms</strong>
    </p>

    <div id="resultBox" class="result-box">
      <p id="status">Inicie uma pesquisa para encontrar sua faixa.</p>
    </div>
  </div>
</div>
<script>
  // LEITURA DE DADOS SEGURA
  let rawData = [];
  const scriptElement = document.getElementById("spotify-data");

  if (scriptElement && scriptElement.textContent.trim().length > 0) {
    try {
      rawData = JSON.parse(scriptElement.textContent);
    } catch (e) {
      console.error(
        "Erro fatal: N√£o foi poss√≠vel processar os dados do servidor.",
        e
      );
    }
  }

  let isSearching = false;

  // Refer√™ncias de elementos DOM
  const targetInput = document.getElementById("target");
  const searchButton = document.getElementById("searchButton");
  const totalRecordsDisplay = document.getElementById("totalRegistros");
  const timeElapsedDisplay = document.getElementById("time-elapsed");
  const resultBox = document.getElementById("resultBox");

  document.addEventListener("DOMContentLoaded", () => {
    totalRecordsDisplay.innerHTML = `Total de M√∫sicas no nosso Cat√°logo: <strong>${rawData.length}</strong>`;

    // Adiciona o listener para a tecla Enter
    targetInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter" || event.keyCode === 13) {
        event.preventDefault();
        startSearch();
      }
    });
  });

  // ----------------------------------------------------------------------------------
  // FUN√á√ïES DE DISPLAY
  // ----------------------------------------------------------------------------------

  function displayResult(
    statusText,
    success = true,
    musica = null,
    duration = 0
  ) {
    // Mostrar o tempo de busca
    timeElapsedDisplay.innerHTML = `Busca conclu√≠da em: <strong>${duration.toFixed(
      3
    )} ms</strong>`;
    timeElapsedDisplay.style.display = "block";

    let htmlContent = "";

    if (!musica) {
      // Tratamento de M√∫sica N√£o Encontrada
      htmlContent = `<p class="not-found">‚ùå Ops! ${statusText}</p>`;
      resultBox.classList.remove("found");
      resultBox.classList.add("not-found");
      resultBox.innerHTML = htmlContent;
      return;
    }

    // Extrair campos
    const genero = musica.playlist_genre || "G√™nero Desconhecido";
    const popularidade = musica.track_popularity || "N/A";

    // L√≥gica para formatar Dura√ß√£o (duration_ms) para MM:SS
    const duracaoMs = musica.duration_ms || 0;
    let duracaoFormatada = "N/A";

    if (duracaoMs > 0) {
      const minutos = Math.floor(duracaoMs / 60000);
      const segundos = Math.round((duracaoMs % 60000) / 1000);
      // Garante formato MM:SS
      duracaoFormatada = minutos + ":" + (segundos < 10 ? "0" : "") + segundos;
    }

    // Construir o HTML
    if (success) {
      htmlContent = `
<div class="song-info">
<span class="track-number">üéß</span>
<div class="track-details">
<p class="result-title">Melhor Correspond√™ncia Encontrada</p>
<p><strong>${musica.track_name}</strong></p>
<p class="artist-name">Artista: ${musica.track_artist}</p>
<p class="artist-name">
 G√™nero: <strong>${genero}</strong> | 
 Popularidade: ${popularidade}% | 
 Dura√ß√£o: ${duracaoFormatada} 
</p>
</div>
</div>
`;
    }

    resultBox.innerHTML = htmlContent;
    resultBox.classList.remove("not-found");
    resultBox.classList.add("found");
  }

  function setSearchingStatus() {
    isSearching = true;
    searchButton.disabled = true;
    searchButton.textContent = "Buscando...";
    timeElapsedDisplay.style.display = "none";
    resultBox.classList.remove("found", "not-found");
    resultBox.innerHTML =
      '<p class="loading-status">üîé Procurando no cat√°logo...</p>';
  }

  function resetSearch() {
    isSearching = false;
    searchButton.disabled = false;
    searchButton.textContent = "Buscar";
    timeElapsedDisplay.innerHTML = `Tempo de Busca: <strong>0 ms</strong>`;
    timeElapsedDisplay.style.display = "none";
    resultBox.innerHTML =
      '<p id="status">Inicie uma pesquisa para encontrar sua faixa.</p>';
    resultBox.classList.remove("found", "not-found");
  }

  // ----------------------------------------------------------------------------------
  // L√ìGICA DA BUSCA SEQUENCIAL
  // ----------------------------------------------------------------------------------

  async function startSearch() {
    if (isSearching || rawData.length === 0) return;

    setSearchingStatus();

    const query = document.getElementById("target").value.trim().toLowerCase();

    if (query.length < 1) {
      resetSearch();
      displayResult(
        "Por favor, digite o nome de uma m√∫sica ou artista para buscar.",
        false,
        null,
        0
      );
      return;
    }

    const totalData = rawData.length;
    let found = false;
    let steps = 0;
    const startTime = performance.now();
    let endTime = 0;

    // Adiciona um pequeno delay para que o status "Buscando..." seja vis√≠vel
    await new Promise((resolve) => setTimeout(resolve, 100));

    for (let i = 0; i < totalData; i++) {
      steps++;
      const currentMusic = rawData[i];

      const trackName = currentMusic.track_name.toLowerCase();
      const artistName = currentMusic.track_artist.toLowerCase();

      const isMatch = trackName.includes(query) || artistName.includes(query);

      if (isMatch) {
        endTime = performance.now();
        const musica = currentMusic;
        const duration = endTime - startTime;

        displayResult(`M√∫sica ENCONTRADA!`, true, musica, duration);
        found = true;
        break; // Interrompe a busca sequencial
      }
    }

    if (!found) {
      endTime = performance.now();
      const duration = endTime - startTime;
      displayResult(
        `N√£o encontramos resultados para "${document
          .getElementById("target")
          .value.trim()}" no cat√°logo.`,
        false,
        null,
        duration
      );
    }

    isSearching = false;
    searchButton.disabled = false;
    searchButton.textContent = "Buscar";
  }
</script>

{% endblock content %}
