{% extends 'base.html' %} 

{% block title %}Busca por Nome (Padr√£o) | Cat√°logo Premium{%endblock %} 

{% block content %}
{{ dados_para_js|json_script:"spotify-data" }}

<h1 style="color: #00b409">
üé∂ Busca por Nome: Encontre a Faixa Exata
<hr style="border-color: #333333" />
</h1>
<p>
Acesse nosso cat√°logo exclusivo. Digite o <strong>T√≠tulo da M√∫sica</strong> ou o <strong>Nome do Artista</strong> abaixo para realizar uma busca completa em toda a nossa biblioteca.
</p>

<style>
/* --------------------------------------------- */
/* --- ANIMA√á√ÉO DE BORDA (SOLU√á√ÉO FINAL) --- */
/* --------------------------------------------- */

@keyframes spin {
to {
transform: rotate(360deg);
}
}

/* Layout Flex√≠vel */
.container-main {
display: flex;
gap: 50px;
margin-top: 30px;
}

.column-left {
flex: 0 0 400px;
}

.column-right {
flex: 1;
}

/* Estilos da Caixa de Comando (Busca) */
.command-box {
border: 1px solid #282828;
border-radius: 12px;
padding: 30px;
margin-bottom: 25px;
background-color: #1a1a1a;
box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
}
strong {
color: #00b409;
}

.controls {
margin-top: 15px;
display: flex;
flex-direction: column;
}

.controls label {
color: #e0e0e0;
margin-bottom: 5px;
}

/* 1. Cont√™iner Principal do Efeito */
.input-wrapper {
position: relative;
border-radius: 8px;
/* Padding define a espessura da borda animada */
padding: 3px;
background: #333; /* Cor da borda est√°tica (n√£o focada) */
overflow: hidden;
transition: background 0.3s;
}

/* 3. Pseudo-Elemento (O GRADIENTE ROTATIVO) */
.input-wrapper::before {
content: "";
position: absolute;
top: -100%;
left: -100%;
width: 300%;
height: 300%;
border-radius: 8px;
opacity: 0;
z-index: 1;

/* Gradiente C√¥nico: Preto/Verde/Preto para o efeito de rastro */
background: conic-gradient(from 0deg, #121212, #00b409, #121212);

transition: opacity 0.40s;
}

/* 4. Anima√ß√£o Ativada pela Classe JavaScript */
.input-wrapper.is-focused::before {
opacity: 1;
animation: spin 40s linear infinite;
}

/* 5. O Input F√≠sico */
.controls input {
width: 100%;
box-sizing: border-box;
padding: 14px 18px;
border-radius: 5px;
border: none; /* Sem borda pr√≥pria */
background-color: #242424;
color: #ffffff;
font-size: 1.1em;
position: relative;
z-index: 3;
transition: background-color 0.3s;
box-shadow: none;
outline: none; /* Remove o outline padr√£o do navegador */
}

/* Estilos do Bot√£o (Mantidos) */
button {
background-color: #00b409;
color: black;
font-weight: 700;
border: none;
padding: 14px 25px;
border-radius: 50px;
cursor: pointer;
transition: background-color 0.3s, transform 0.1s;
margin-top: 20px;
font-size: 1.1em;
letter-spacing: 0.5px;
}
button:hover {
background-color: #1ed760;
transform: translateY(-2px);
box-shadow: 0 4px 8px rgba(0, 180, 9, 0.5);
}
button:disabled {
background-color: #444;
color: #aaa;
cursor: not-allowed;
transform: none;
box-shadow: none;
}

/* Status de Registros */
#totalRegistros {
color: #999999;
font-size: 0.95em;
padding-left: 5px;
}

/* Status e Tempo de Busca */
#time-elapsed {
font-size: 0.9em;
color: #999999;
text-align: right;
margin-top: 10px;
font-style: italic;
}

/* Estilos da Caixa de Resultado */
.result-box {
border: 1px solid #282828;
border-radius: 12px;
padding: 25px;
background-color: #1a1a1a;
color: #ffffff;
box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
margin-top: 15px;
min-height: 100px;
display: flex;
align-items: center;
transition: border-color 0.4s;
}

.found {
border: 2px solid #1db954;
background-color: #151515;
}

.not-found {
border: 2px solid #ff4d4d;
background-color: #1a1a1a;
}

/* Informa√ß√µes da M√∫sica (CORRIGIDO) */
.song-info {
display: flex;
align-items: flex-start;
gap: 20px;
width: 100%;
}
.track-number {
color: #1ed760;
font-size: 2.5em;
line-height: 1;
flex-shrink: 0;
}
.track-details p {
margin: 2px 0;
line-height: 1.5;
}

/* NOVO ESTILO: Garante que o STRONG que envolve o link se comporte como texto inline */
.track-details p:nth-child(2) strong {
    display: inline;
}

.track-details strong {
    color: #ffffff;
    font-size: 1.3em;
    /* O display: block foi removido desta regra geral */
}

.track-details .artist-name {
color: #b3b3b3;
font-size: 1em;
margin-bottom: 8px;
}
.track-details .metadata {
color: #999999;
font-size: 0.9em;
}
.result-title {
color: #1db954;
font-size: 0.9em;
font-weight: 600;
margin-bottom: 5px !important;
}

/* --- ESTILOS DO LINK DO YOUTUBE (Essenciais) --- */
.youtube-link {
    color: #ffffff; /* Garante que o link tenha cor branca inicialmente */
    text-decoration: none;
    cursor: pointer;
    transition: color 0.2s;
}

.youtube-link:hover {
    color: #1ed760;
    text-decoration: underline;
}
/* --- FIM DOS ESTILOS DO LINK --- */


/* Indicador de Loading */
.loading-status {
color: #1ed760;
font-style: italic;
font-size: 1.1em;
}

/* responsividade */
@media (max-width: 768px) {
.container-main {
flex-direction: column;
gap: 30px;
}
.column-left {
flex: 1;
min-width: 100%;
}
.controls input,
.controls button {
width: 100% !important;
box-sizing: border-box;
}
.command-box {
padding: 20px;
}
}
</style>

<div class="container-main">
<div class="column-left">
    <div class="command-box">
        <p style="margin-top: 0">
            <strong>Busca Direta</strong>
        </p>
        <div class="controls">
            <label for="target">Nome da M√∫sica ou Artista:</label>

            <div class="input-wrapper">
                <input
                    type="text"
                    id="target"
                    value=""
                    placeholder="Ex: Do I Wanna Know? ou Arctic Monkeys"
                />
            </div>

            <button id="searchButton" onclick="startSearch()">
                Encontrar Agora
            </button>
        </div>
    </div>

    <p id="totalRegistros">Carregando dados...</p>
</div>
<div class="column-right">
    <h2>Seu Resultado:</h2>

    <p id="time-elapsed" style="display: none">
        An√°lise de Tempo: <strong>0 ms</strong>
    </p>

    <div id="resultBox" class="result-box">
        <p id="status">Use a busca para ver os detalhes da faixa.</p>
    </div>
</div>
</div>
<script>
// LEITURA DE DADOS SEGURA
let rawData = [];
const scriptElement = document.getElementById("spotify-data");

if (scriptElement && scriptElement.textContent.trim().length > 0) {
    try {
        rawData = JSON.parse(scriptElement.textContent);
    } catch (e) {
        console.error(
            "Erro fatal: N√£o foi poss√≠vel processar os dados do servidor.",
            e
        );
    }
}

let isSearching = false;

// Refer√™ncias de elementos DOM
const targetInput = document.getElementById("target");
const searchButton = document.getElementById("searchButton");
const totalRecordsDisplay = document.getElementById("totalRegistros");
const timeElapsedDisplay = document.getElementById("time-elapsed");
const resultBox = document.getElementById("resultBox");

// Refer√™ncia ao wrapper do input para gerenciar a classe de foco
const inputWrapper = document.querySelector(".input-wrapper");

document.addEventListener("DOMContentLoaded", () => {
    totalRecordsDisplay.innerHTML = `Cat√°logo de M√∫sicas: <strong>${rawData.length} Faixas</strong>`;

    // Adiciona o listener para a tecla Enter
    targetInput.addEventListener("keydown", function (event) {
        if (event.key === "Enter" || event.keyCode === 13) {
            event.preventDefault();
            startSearch();
        }
    });

    // L√≥gica para ativar a anima√ß√£o no foco via JavaScript
    if (targetInput && inputWrapper) {
        targetInput.addEventListener("focus", () => {
            inputWrapper.classList.add("is-focused");
        });
        targetInput.addEventListener("blur", () => {
            inputWrapper.classList.remove("is-focused");
        });
    }
});

// ----------------------------------------------------------------------------------
// FUN√á√ïES DE DISPLAY (COM LINK DO YOUTUBE)
// ----------------------------------------------------------------------------------

function displayResult(
    statusText,
    success = true,
    musica = null,
    duration = 0
) {
    // Mostrar o tempo de busca
    timeElapsedDisplay.innerHTML = `Busca conclu√≠da em: <strong>${duration.toFixed(
        3
    )} ms</strong>`;
    timeElapsedDisplay.style.display = "block";

    let htmlContent = "";

    if (!musica) {
        // Tratamento de M√∫sica N√£o Encontrada
        htmlContent = `<p class="not-found">‚ùå Ops! ${statusText}</p>`;
        resultBox.classList.remove("found");
        resultBox.classList.add("not-found");
        resultBox.innerHTML = htmlContent;
        return;
    }

    // Extrair campos
    const genero = musica.playlist_genre || "G√™nero Desconhecido";
    const popularidade = musica.track_popularity || "N/A";
    const trackName = musica.track_name || 'Nome Desconhecido';
    const artistName = musica.track_artist || 'Artista Desconhecido';

    // L√≥gica para formatar Dura√ß√£o (duration_ms) para MM:SS
    const duracaoMs = musica.duration_ms || 0;
    let duracaoFormatada = "N/A";

    if (duracaoMs > 0) {
        const minutos = Math.floor(duracaoMs / 60000);
        const segundos = Math.round((duracaoMs % 60000) / 1000);
        // Garante formato MM:SS
        duracaoFormatada = minutos + ":" + (segundos < 10 ? "0" : "") + segundos;
    }
     
    // ----------------------------------------------------
    // CONSTRU√á√ÉO DO LINK DO YOUTUBE
    // ----------------------------------------------------
    const searchTerm = `${trackName} ${artistName}`;
    const encodedSearch = encodeURIComponent(searchTerm);
    const youtubeUrl = `https://www.youtube.com/results?search_query=${encodedSearch}`;
    // ----------------------------------------------------

    // Construir o HTML
    if (success) {
        htmlContent = `
<div class="song-info">
<span class="track-number">üéß</span>
<div class="track-details">
<p class="result-title">Encontramos a faixa no cat√°logo!</p>
<p>
    <strong>
        <a href="${youtubeUrl}" target="_blank" class="youtube-link">
            ${trackName} 
            <span style="color: #00b409; font-size: 0.7em;">üîó</span>
        </a>
    </strong>
</p>
<p class="artist-name">Artista: ${artistName}</p>
<p class="metadata">
G√™nero: <strong class="highlight-green">${genero}</strong> | 
Popularidade: ${popularidade}% | 
Dura√ß√£o: ${duracaoFormatada} 
</p>
</div>
</div>
`;
    }

    resultBox.innerHTML = htmlContent;
    resultBox.classList.remove("not-found");
    resultBox.classList.add("found");
}

function setSearchingStatus() {
    isSearching = true;
    searchButton.disabled = true;
    searchButton.textContent = "Procurando...";
    timeElapsedDisplay.style.display = "none";
    resultBox.classList.remove("found", "not-found");
    resultBox.innerHTML =
        '<p class="loading-status">üîé Analisando o cat√°logo...</p>';
}

function resetSearch() {
    isSearching = false;
    searchButton.disabled = false;
    searchButton.textContent = "Encontrar Agora";
    timeElapsedDisplay.innerHTML = `An√°lise de Tempo: <strong>0 ms</strong>`;
    timeElapsedDisplay.style.display = "none";
    resultBox.innerHTML =
        '<p id="status">Use a busca para ver os detalhes da faixa.</p>';
    resultBox.classList.remove("found", "not-found");
}

// ----------------------------------------------------------------------------------
// L√ìGICA DA BUSCA SEQUENCIAL (Mantida)
// ----------------------------------------------------------------------------------

async function startSearch() {
    if (isSearching || rawData.length === 0) return;

    setSearchingStatus();

    const query = document.getElementById("target").value.trim().toLowerCase();

    if (query.length < 1) {
        resetSearch();
        displayResult(
            "Por favor, digite o nome de uma m√∫sica ou artista para buscar.",
            false,
            null,
            0
        );
        return;
    }

    const totalData = rawData.length;
    let found = false;
    let steps = 0;
    const startTime = performance.now();
    let endTime = 0;

    // Adiciona um pequeno delay para que o status "Procurando..." seja vis√≠vel
    await new Promise((resolve) => setTimeout(resolve, 100));

    for (let i = 0; i < totalData; i++) {
        steps++;
        const currentMusic = rawData[i];

        const trackName = currentMusic.track_name.toLowerCase();
        const artistName = currentMusic.track_artist.toLowerCase();

        const isMatch = trackName.includes(query) || artistName.includes(query);

        if (isMatch) {
            endTime = performance.now();
            const musica = currentMusic;
            const duration = endTime - startTime;

            displayResult(`M√∫sica ENCONTRADA!`, true, musica, duration);
            found = true;
            break; // Interrompe a busca sequencial
        }
    }

    if (!found) {
        endTime = performance.now();
        const duration = endTime - startTime;
        displayResult(
            `Essa faixa n√£o est√° no nosso cat√°logo. Tente outro t√≠tulo ou artista.`,
            false,
            null,
            duration
        );
    }

    isSearching = false;
    searchButton.disabled = false;
    searchButton.textContent = "Encontrar Agora";
}
</script>

{% endblock content %}